


/* ================================================
   TRANSLATIONS â€” Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ±Ø¬Ù…Ø©
================================================ */
const TRANSLATIONS = {
  ar: {
    login_title:"ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„", login_btn:"Ø¯Ø®ÙˆÙ„", logout:"Ø®Ø±ÙˆØ¬",
    pin_placeholder:"Ø±Ù…Ø² PIN",
    menu_sale:"ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¨ÙŠØ¹", menu_stock:"ğŸ“¦ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†",
    menu_customers:"ğŸ‘¥ Ø§Ù„Ø²Ø¨Ø§Ø¦Ù†", menu_users:"ğŸ‘¤ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†",
    menu_reports:"ğŸ“Š Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ù…Ø§Ù„", menu_settings:"âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª",
    back:"Ø§Ù„Ø±Ø¬ÙˆØ¹",
    sale_title:"ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¨ÙŠØ¹",
    search_placeholder:"Ø§Ø³Ù… Ø£Ùˆ Ø¨Ø§Ø±ÙƒÙˆØ¯",
    add_btn:"â• Ø¥Ø¶Ø§ÙØ©",
    col_item:"Ø³Ù„Ø¹Ø©", col_qty:"ÙƒÙ…ÙŠØ©", col_price:"Ø³Ø¹Ø±",
    col_total:"Ù…Ø¬Ù…ÙˆØ¹", col_options:"Ø®ÙŠØ§Ø±Ø§Øª",
    col_name:"Ø§Ù„Ø§Ø³Ù…", col_role:"Ø§Ù„Ø¯ÙˆØ±",
    paid_placeholder:"Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹",
    pay_btn:"âœ… ØªØ³Ø¯ÙŠØ¯", partial_btn:"ğŸ’° Ø¬Ø²Ø¦ÙŠ", debt_btn:"ğŸ“‹ Ø¯ÙŠÙ†",
    tab_families:"Ø§Ù„Ø¹Ø§Ø¦Ù„Ø§Øª", tab_brands:"Ø§Ù„Ù…Ø§Ø±ÙƒØ§Øª", tab_all_stock:"ÙƒÙ„ Ø§Ù„Ø³Ù„Ø¹",
    families_title:"ğŸ“ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø§Øª â€” Ù†ÙˆØ¹ Ø§Ù„Ù…Ù†ØªØ¬",
    brands_title:"ğŸ·ï¸ Ø§Ù„Ù…Ø§Ø±ÙƒØ§Øª â€” Ø¹Ø§Ø¦Ù„Ø© Ø§Ù„Ù…Ù†ØªØ¬",
    add_product_title:"â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯",
    all_products:"ğŸ“‹ ÙƒÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª",
    family_ph:"Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©...",
    brand_ph:"Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø±ÙƒØ©...",
    add_family:"â• Ø¥Ø¶Ø§ÙØ©", add_brand:"â• Ø¥Ø¶Ø§ÙØ©",
    family_label:"Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©", brand_label:"Ø§Ù„Ù…Ø§Ø±ÙƒØ©",
    size_label:"Ø§Ù„Ø­Ø¬Ù… / Ø§Ù„Ù…Ù‚Ø§Ø³", barcode_label:"Ø¨Ø§Ø±ÙƒÙˆØ¯",
    price_label:"Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹", cost_label:"Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡",
    qty_label:"Ø§Ù„ÙƒÙ…ÙŠØ©", exp_label:"ØªØ§Ø±ÙŠØ® Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©",
    save_item:"ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬",
    stock_search_ph:"ğŸ” Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†...",
    edit_btn:"ØªØ¹Ø¯ÙŠÙ„", del_btn:"Ù…Ø³Ø­",
    tab_day:"Ø§Ù„ÙŠÙˆÙ…", tab_week:"Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹", tab_month:"Ø§Ù„Ø´Ù‡Ø±",
    tab_year:"Ø§Ù„Ø³Ù†Ø©", tab_all:"Ø§Ù„ÙƒÙ„",
    r_sales:"Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø¨ÙŠØ¹", r_revenue:"Ø§Ù„Ù…Ø¯Ø§Ø®ÙŠÙ„",
    r_cost:"ØªÙƒÙ„ÙØ© Ø§Ù„Ø´Ø±Ø§Ø¡", r_profit:"ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­",
    debts_title:"ğŸ“‹ ØªØªØ¨Ø¹ Ø§Ù„Ø¯ÙŠÙˆÙ†",
    total_debts:"Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙŠÙˆÙ†", debtors_count:"Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¯ÙŠÙ†ÙŠÙ†",
    sales_log:"ğŸ“œ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª",
    settle_btn:"ØªØ³ÙˆÙŠØ©",
    no_debts:"Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙŠÙˆÙ† ğŸ‰", no_sales:"Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª",
    stab_app:"ğŸ–¥ï¸ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬", stab_store:"ğŸª Ø§Ù„Ù…ØªØ¬Ø±",
    stab_print:"ğŸ–¨ï¸ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©", stab_system:"ğŸ”§ Ø§Ù„Ù†Ø¸Ø§Ù…",
    date_format:"ØµÙŠØºØ© Ø§Ù„ØªØ§Ø±ÙŠØ®", time_format:"ØµÙŠØºØ© Ø§Ù„ÙˆÙ‚Øª",
    currency_label:"Ø±Ù…Ø² Ø§Ù„Ø¹Ù…Ù„Ø©", lang_label:"Ù„ØºØ© Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬",
    save_app:"ğŸ’¾ Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬",
    logo_label:"Ø´Ø¹Ø§Ø± Ø§Ù„Ù…ØªØ¬Ø±",
    upload_logo:"ğŸ“· ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø¹Ø§Ø±", remove_logo:"ğŸ—‘ï¸ Ø­Ø°Ù",
    shop_name:"Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¬Ø±", phone_label:"Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ",
    address_label:"Ø§Ù„Ø¹Ù†ÙˆØ§Ù†", welcome_label:"Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨ Ù„Ù„ÙØ§ØªÙˆØ±Ø©",
    save_store:"ğŸ’¾ Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªØ¬Ø±",
    invoice_num:"Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠ (Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„)",
    printer_label:"Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø·Ø§Ø¨Ø¹Ø©", paper_size:"Ù…Ù‚Ø§Ø³ Ø§Ù„ÙˆØ±Ù‚",
    copies_label:"Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ø³Ø®",
    print_logo:"Ø·Ø¨Ø§Ø¹Ø© Ø´Ø¹Ø§Ø± Ø§Ù„Ù…ØªØ¬Ø±", print_name:"Ø·Ø¨Ø§Ø¹Ø© Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¬Ø±",
    print_phone:"Ø·Ø¨Ø§Ø¹Ø© Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ", print_welcome:"Ø·Ø¨Ø§Ø¹Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨",
    print_barcode:"Ø·Ø¨Ø§Ø¹Ø© Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª",
    print_cust_barcode:"Ø·Ø¨Ø§Ø¹Ø© Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¹Ù„Ù‰ ÙˆØ±Ù‚Ø© Ø§Ù„Ø²Ø¨ÙˆÙ†",
    save_print:"ğŸ’¾ Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©",
    auto_backup_title:"ğŸ’¾ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ÙˆØ§Ù„Ù†Ø³Ø® Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ",
    auto_backup_desc:"ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù†Ø³Ø® Ø§Ù„ÙŠÙˆÙ…ÙŠ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙˆØ³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª.",
    auto_backup_toggle:"ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù†Ø³Ø® Ø§Ù„ÙŠÙˆÙ…ÙŠ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ",
    manual_backup:"ğŸ“¥ Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø§Ù„Ø¢Ù†",
    reset_btn:"ğŸ”´ Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ù†Ø¸Ø§Ù…",
    reset_warning:"âš ï¸ ØªØ­Ø°ÙŠØ±: Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø²Ø¡ Ø³ÙŠÙ‚ÙˆÙ… Ø¨Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø§Ù„Ù…Ù†ØªØ¬Ø§ØªØŒ Ø§Ù„ÙÙˆØ§ØªÙŠØ±ØŒ Ø§Ù„Ø²Ø¨Ø§Ø¦Ù†ØŒ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±) ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ù„Ø­Ø§Ù„ØªÙ‡ Ø§Ù„Ø£ØµÙ„ÙŠØ© Ù…Ù† Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©.",
    customer_ph:"Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†",
    username_ph:"Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…",
    role_seller:"Ø¨Ø§Ø¦Ø¹", role_manager:"Ù…Ø¯ÙŠØ±",
    add_user:"â• Ø¥Ø¶Ø§ÙØ©",
    lang_preview:"Ø³ÙŠØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù„ØºØ© Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸.",
    msg_select_user:"Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£ÙˆÙ„Ø§Ù‹",
    msg_wrong_pin:"Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ Ø§Ù„Ø±Ù…Ø² Ø®Ø§Ø·Ø¦",
    msg_saved:"âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­!",
    msg_family_exists:"Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹",
    msg_brand_exists:"Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø§Ø±ÙƒØ© Ù…ÙˆØ¬ÙˆØ¯Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹",
    msg_select_family:"Ø§Ø®ØªØ± Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹",
    msg_barcode_exists:"Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹",
    msg_item_updated:"Ø§Ù„Ù…Ù†ØªØ¬ Ù…ÙˆØ¬ÙˆØ¯ â€” ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒÙ…ÙŠØ©!",
    msg_item_saved:"âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­!",
    msg_fill_all:"Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­!",
    msg_no_cart:"Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ø§Ù„Ø¹Ø±Ø¨Ø©!",
    msg_low_balance:"Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ",
    msg_sold:"âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ¹ Ø¨Ù†Ø¬Ø§Ø­!",
    msg_change:"âœ… ØªÙ… Ø§Ù„Ø¨ÙŠØ¹!\nØ§Ù„Ø¨Ø§Ù‚ÙŠ Ù„Ù„Ø²Ø¨ÙˆÙ†: ",
    msg_partial_ok:"âœ… Ø¯ÙØ¹ Ø¬Ø²Ø¦ÙŠ!\nÙ…Ø¯ÙÙˆØ¹: ",
    msg_partial_rem:"\nÙ…ØªØ¨Ù‚ÙŠ: ",
    msg_need_amount:"Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹",
    msg_covers_all:"Ø§Ù„Ù…Ø¨Ù„Øº ÙŠØºØ·ÙŠ Ø§Ù„ÙƒÙ„ØŒ Ø§Ø³ØªØ®Ø¯Ù… 'ØªØ³Ø¯ÙŠØ¯'",
    msg_select_customer:"Ø§Ø®ØªØ± Ø²Ø¨ÙˆÙ†Ø§Ù‹ Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙŠÙ† Ø¹Ù„ÙŠÙ‡",
    msg_debt_ok:"âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙŠÙ† Ø¹Ù„Ù‰ ",
    msg_debt_amount:"\nØ§Ù„Ù…Ø¨Ù„Øº: ",
    msg_out_of_stock:"Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ Ù†ÙØ° Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ†!",
    msg_not_enough:"Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø®Ø²ÙˆÙ† ÙƒØ§ÙÙ!",
    msg_not_found:"Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†",
    msg_enter_search:"Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø³Ù„Ø¹Ø© Ø£Ùˆ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯",
    msg_customer_exists:"Ø§Ù„Ø²Ø¨ÙˆÙ† Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹",
    msg_enter_customer:"Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†",
    msg_user_exists:"Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ù‹Ø§",
    msg_pin_format:"Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… ØµØ­ÙŠØ­ ÙˆPIN Ù…Ù† 4 Ø£Ø±Ù‚Ø§Ù…",
    msg_pin_4:"PIN ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 4 Ø£Ø±Ù‚Ø§Ù…",
    msg_cant_delete:"Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…",
    msg_confirm_delete_user:"Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ",
    msg_confirm_delete:"Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ØŸ",
    msg_confirm_delete_customer:"Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø²Ø¨ÙˆÙ†ØŸ",
    msg_confirm_delete_family:"Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ù…Ø§Ø±ÙƒØ§ØªÙ‡Ø§ Ø£ÙŠØ¶Ø§Ù‹.",
    msg_confirm_delete_brand:"Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø§Ø±ÙƒØ©ØŸ",
    msg_backup_done:"âœ… ØªÙ… ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©!",
    msg_backup_auto_on:"âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù†Ø³Ø® Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø§Ù„ÙŠÙˆÙ…ÙŠ.",
    msg_backup_auto_off:"ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù†Ø³Ø® Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ.",
    msg_reset_confirm:"Ø§ÙƒØªØ¨ 'Ù†Ø¹Ù…' Ù„Ù„ØªØ£ÙƒÙŠØ¯:",
    msg_reset_done:"âœ… ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ù†Ø¸Ø§Ù….",
    msg_reset_cancel:"ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©.",
    settle_prompt:"Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹:",
    settle_ok:"âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹ ",
    settle_from:" Ù…Ù† ",
    no_stock:"Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙØ§Ø±Øº",
    no_families:"Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø§Ø¦Ù„Ø§Øª Ø¨Ø¹Ø¯",
    no_brands:"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø§Ø±ÙƒØ§Øª Ø¨Ø¹Ø¯",
    no_customers:"Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø²Ø¨Ø§Ø¦Ù† Ø¨Ø¹Ø¯",
    msg_clear_month_confirm:"Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹.",
    msg_clear_year_confirm:"Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø³Ù†Ø©ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹.",
    msg_clear_done:"âœ… ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­.",
    msg_clear_cancel:"ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©.",
  },

  fr: {
    login_title:"Connexion", login_btn:"Entrer", logout:"DÃ©connexion",
    pin_placeholder:"Code PIN",
    menu_sale:"Vente", menu_stock:"ğŸ“¦ Stock",
    menu_customers:"ğŸ‘¥ Clients", menu_users:"ğŸ‘¤ Utilisateurs",
    menu_reports:"ğŸ“Š Gestion", menu_settings:"âš™ï¸ ParamÃ¨tres",
    back:"Retour",
    sale_title:"Interface de vente",
    search_placeholder:"Nom ou code-barres",
    add_btn:"â• Ajouter",
    col_item:"Article", col_qty:"QtÃ©", col_price:"Prix",
    col_total:"Total", col_options:"Options",
    col_name:"Nom", col_role:"RÃ´le",
    paid_placeholder:"Montant payÃ©",
    pay_btn:"âœ… Payer", partial_btn:"ğŸ’° Partiel", debt_btn:"ğŸ“‹ CrÃ©dit",
    tab_families:"Familles", tab_brands:"Marques", tab_all_stock:"Tous les articles",
    families_title:"ğŸ“ Familles â€” Type de produit",
    brands_title:"ğŸ·ï¸ Marques â€” Famille de produit",
    add_product_title:"â• Ajouter un produit",
    all_products:"ğŸ“‹ Tous les produits",
    family_ph:"Entrer le nom de la famille...",
    brand_ph:"Entrer le nom de la marque...",
    add_family:"â• Ajouter", add_brand:"â• Ajouter",
    family_label:"Famille", brand_label:"Marque",
    size_label:"Taille / Format", barcode_label:"Code-barres",
    price_label:"Prix de vente", cost_label:"Prix d'achat",
    qty_label:"QuantitÃ©", exp_label:"Date d'expiration",
    save_item:"ğŸ’¾ Enregistrer",
    stock_search_ph:"ğŸ” Rechercher dans le stock...",
    edit_btn:"Modifier", del_btn:"Supprimer",
    tab_day:"Aujourd'hui", tab_week:"Semaine", tab_month:"Mois",
    tab_year:"AnnÃ©e", tab_all:"Tout",
    r_sales:"Ventes", r_revenue:"Revenus",
    r_cost:"CoÃ»t d'achat", r_profit:"BÃ©nÃ©fice net",
    debts_title:"ğŸ“‹ Suivi des dettes",
    total_debts:"Total dettes", debtors_count:"Nb dÃ©biteurs",
    sales_log:"ğŸ“œ Journal des opÃ©rations",
    settle_btn:"RÃ©gler",
    no_debts:"Pas de dettes ğŸ‰", no_sales:"Pas d'opÃ©rations",
    stab_app:"ğŸ–¥ï¸ Programme", stab_store:"ğŸª Boutique",
    stab_print:"ğŸ–¨ï¸ Impression", stab_system:"ğŸ”§ SystÃ¨me",
    date_format:"Format de date", time_format:"Format de l'heure",
    currency_label:"Symbole monÃ©taire", lang_label:"Langue",
    save_app:"ğŸ’¾ Sauvegarder",
    logo_label:"Logo de la boutique",
    upload_logo:"ğŸ“· Charger logo", remove_logo:"ğŸ—‘ï¸ Supprimer",
    shop_name:"Nom de la boutique", phone_label:"TÃ©lÃ©phone",
    address_label:"Adresse", welcome_label:"Message de bienvenue",
    save_store:"ğŸ’¾ Sauvegarder",
    invoice_num:"NumÃ©ro de facture",
    printer_label:"Imprimante", paper_size:"Format papier",
    copies_label:"Nombre de copies",
    print_logo:"Imprimer logo", print_name:"Imprimer nom boutique",
    print_phone:"Imprimer tÃ©lÃ©phone", print_welcome:"Imprimer message accueil",
    print_barcode:"Imprimer codes-barres produits",
    print_cust_barcode:"Imprimer code-barres client",
    save_print:"ğŸ’¾ Sauvegarder",
    auto_backup_title:"ğŸ’¾ Sauvegarde automatique",
    auto_backup_desc:"Activer la sauvegarde quotidienne automatique des donnÃ©es.",
    auto_backup_toggle:"Activer la sauvegarde automatique quotidienne",
    manual_backup:"ğŸ“¥ Sauvegarder maintenant",
    reset_btn:"ğŸ”´ RÃ©initialiser le systÃ¨me",
    reset_warning:"âš ï¸ Attention : Cette action supprimera toutes les donnÃ©es et remettra le programme Ã  son Ã©tat initial.",
    customer_ph:"Nom du client",
    username_ph:"Nom d'utilisateur",
    role_seller:"Vendeur", role_manager:"Directeur",
    add_user:"â• Ajouter",
    lang_preview:"La langue sera appliquÃ©e aprÃ¨s sauvegarde.",
    msg_select_user:"Veuillez sÃ©lectionner un utilisateur",
    msg_wrong_pin:"Utilisateur ou PIN incorrect",
    msg_saved:"âœ… SauvegardÃ© avec succÃ¨s!",
    msg_family_exists:"Cette famille existe dÃ©jÃ ",
    msg_brand_exists:"Cette marque existe dÃ©jÃ ",
    msg_select_family:"SÃ©lectionnez une famille d'abord",
    msg_barcode_exists:"Ce code-barres existe dÃ©jÃ ",
    msg_item_updated:"Produit existant â€” quantitÃ© mise Ã  jour!",
    msg_item_saved:"âœ… Produit ajoutÃ© avec succÃ¨s!",
    msg_fill_all:"Veuillez remplir tous les champs correctement!",
    msg_no_cart:"Aucun produit dans le panier!",
    msg_low_balance:"Montant payÃ© infÃ©rieur au total",
    msg_sold:"âœ… Vente enregistrÃ©e!",
    msg_change:"âœ… Vente!\nMonnaie Ã  rendre: ",
    msg_partial_ok:"âœ… Paiement partiel!\nPayÃ©: ",
    msg_partial_rem:"\nReste: ",
    msg_need_amount:"Entrez le montant partiel",
    msg_covers_all:"Le montant couvre tout, utilisez 'Payer'",
    msg_select_customer:"SÃ©lectionnez un client pour le crÃ©dit",
    msg_debt_ok:"âœ… CrÃ©dit enregistrÃ© pour ",
    msg_debt_amount:"\nMontant: ",
    msg_out_of_stock:"Produit en rupture de stock!",
    msg_not_enough:"Stock insuffisant!",
    msg_not_found:"Produit introuvable",
    msg_enter_search:"Entrez un nom ou code-barres",
    msg_customer_exists:"Ce client existe dÃ©jÃ ",
    msg_enter_customer:"Entrez le nom du client",
    msg_user_exists:"Cet utilisateur existe dÃ©jÃ ",
    msg_pin_format:"Entrez un nom valide et PIN Ã  4 chiffres",
    msg_pin_4:"Le PIN doit Ãªtre 4 chiffres",
    msg_cant_delete:"Impossible de supprimer cet utilisateur",
    msg_confirm_delete_user:"Confirmer la suppression de cet utilisateur?",
    msg_confirm_delete:"Supprimer ce produit?",
    msg_confirm_delete_customer:"Confirmer la suppression de ce client?",
    msg_confirm_delete_family:"Supprimer cette famille? Ses marques seront supprimÃ©es.",
    msg_confirm_delete_brand:"Supprimer cette marque?",
    msg_backup_done:"âœ… Sauvegarde tÃ©lÃ©chargÃ©e!",
    msg_backup_auto_on:"âœ… Sauvegarde automatique activÃ©e.",
    msg_backup_auto_off:"Sauvegarde automatique dÃ©sactivÃ©e.",
    msg_reset_confirm:"Tapez 'oui' pour confirmer:",
    msg_reset_done:"âœ… SystÃ¨me rÃ©initialisÃ©.",
    msg_reset_cancel:"OpÃ©ration annulÃ©e.",
    settle_prompt:"Entrez le montant payÃ©:",
    settle_ok:"âœ… Paiement enregistrÃ©: ",
    settle_from:" de ",
    no_stock:"Stock vide", no_families:"Pas encore de familles",
    no_brands:"Pas encore de marques", no_customers:"Pas encore de clients",
    msg_clear_month_confirm:"Supprimer toutes les ventes de ce mois? IrrÃ©versible.",
    msg_clear_year_confirm:"Supprimer toutes les ventes de cette annÃ©e? IrrÃ©versible.",
    msg_clear_done:"âœ… DonnÃ©es supprimÃ©es avec succÃ¨s.",
    msg_clear_cancel:"OpÃ©ration annulÃ©e.",
  },

  en: {
    login_title:"Login", login_btn:"Sign In", logout:"Logout",
    pin_placeholder:"PIN Code",
    menu_sale:"Sales", menu_stock:"ğŸ“¦ Stock",
    menu_customers:"ğŸ‘¥ Customers", menu_users:"ğŸ‘¤ Users",
    menu_reports:"ğŸ“Š Business", menu_settings:"âš™ï¸ Settings",
    back:"Back",
    sale_title:"Sales Interface",
    search_placeholder:"Name or barcode",
    add_btn:"â• Add",
    col_item:"Item", col_qty:"Qty", col_price:"Price",
    col_total:"Total", col_options:"Options",
    col_name:"Name", col_role:"Role",
    paid_placeholder:"Amount paid",
    pay_btn:"âœ… Pay", partial_btn:"ğŸ’° Partial", debt_btn:"ğŸ“‹ Credit",
    tab_families:"Families", tab_brands:"Brands", tab_all_stock:"All Items",
    families_title:"ğŸ“ Families â€” Product type",
    brands_title:"ğŸ·ï¸ Brands â€” Product family",
    add_product_title:"â• Add New Product",
    all_products:"ğŸ“‹ All Products",
    family_ph:"Enter family name...",
    brand_ph:"Enter brand name...",
    add_family:"â• Add", add_brand:"â• Add",
    family_label:"Family", brand_label:"Brand",
    size_label:"Size / Format", barcode_label:"Barcode",
    price_label:"Sale price", cost_label:"Purchase price",
    qty_label:"Quantity", exp_label:"Expiry date",
    save_item:"ğŸ’¾ Save Product",
    stock_search_ph:"ğŸ” Search stock...",
    edit_btn:"Edit", del_btn:"Delete",
    tab_day:"Today", tab_week:"Week", tab_month:"Month",
    tab_year:"Year", tab_all:"All",
    r_sales:"Sales", r_revenue:"Revenue",
    r_cost:"Purchase cost", r_profit:"Net profit",
    debts_title:"ğŸ“‹ Debt Tracking",
    total_debts:"Total debts", debtors_count:"Debtors",
    sales_log:"ğŸ“œ Operations Log",
    settle_btn:"Settle",
    no_debts:"No debts ğŸ‰", no_sales:"No operations",
    stab_app:"ğŸ–¥ï¸ Program", stab_store:"ğŸª Store",
    stab_print:"ğŸ–¨ï¸ Printing", stab_system:"ğŸ”§ System",
    date_format:"Date format", time_format:"Time format",
    currency_label:"Currency symbol", lang_label:"Language",
    save_app:"ğŸ’¾ Save Program Settings",
    logo_label:"Store logo",
    upload_logo:"ğŸ“· Upload logo", remove_logo:"ğŸ—‘ï¸ Remove",
    shop_name:"Store name", phone_label:"Phone number",
    address_label:"Address", welcome_label:"Invoice welcome message",
    save_store:"ğŸ’¾ Save Store Data",
    invoice_num:"Current invoice number",
    printer_label:"Printer", paper_size:"Paper size",
    copies_label:"Number of copies",
    print_logo:"Print store logo", print_name:"Print store name",
    print_phone:"Print phone number", print_welcome:"Print welcome message",
    print_barcode:"Print product barcodes",
    print_cust_barcode:"Print barcode on customer receipt",
    save_print:"ğŸ’¾ Save Print Settings",
    auto_backup_title:"ğŸ’¾ Operations Log & Auto Backup",
    auto_backup_desc:"Enable daily automatic backup of app data.",
    auto_backup_toggle:"Enable daily automatic backup",
    manual_backup:"ğŸ“¥ Backup Now",
    reset_btn:"ğŸ”´ Reset System",
    reset_warning:"âš ï¸ Warning: This will delete all data and reset the program to its initial state.",
    customer_ph:"Customer name",
    username_ph:"Username",
    role_seller:"Seller", role_manager:"Manager",
    add_user:"â• Add",
    lang_preview:"Language will be applied after saving.",
    msg_select_user:"Please select a user",
    msg_wrong_pin:"Incorrect username or PIN",
    msg_saved:"âœ… Saved successfully!",
    msg_family_exists:"This family already exists",
    msg_brand_exists:"This brand already exists",
    msg_select_family:"Select a family first",
    msg_barcode_exists:"This barcode already exists",
    msg_item_updated:"Product exists â€” quantity updated!",
    msg_item_saved:"âœ… Product added successfully!",
    msg_fill_all:"Please fill all fields correctly!",
    msg_no_cart:"No products in cart!",
    msg_low_balance:"Amount paid is less than total",
    msg_sold:"âœ… Sale registered!",
    msg_change:"âœ… Sale done!\nChange for customer: ",
    msg_partial_ok:"âœ… Partial payment!\nPaid: ",
    msg_partial_rem:"\nRemaining: ",
    msg_need_amount:"Enter the partial amount",
    msg_covers_all:"Amount covers all, use 'Pay' instead",
    msg_select_customer:"Select a customer for credit",
    msg_debt_ok:"âœ… Credit registered for ",
    msg_debt_amount:"\nAmount: ",
    msg_out_of_stock:"Product out of stock!",
    msg_not_enough:"Insufficient stock!",
    msg_not_found:"Product not found",
    msg_enter_search:"Enter a name or barcode",
    msg_customer_exists:"Customer already exists",
    msg_enter_customer:"Enter customer name",
    msg_user_exists:"Username already exists",
    msg_pin_format:"Enter valid name and 4-digit PIN",
    msg_pin_4:"PIN must be 4 digits",
    msg_cant_delete:"Cannot delete this user",
    msg_confirm_delete_user:"Confirm deleting this user?",
    msg_confirm_delete:"Delete this product?",
    msg_confirm_delete_customer:"Confirm deleting this customer?",
    msg_confirm_delete_family:"Delete this family? Its brands will also be removed.",
    msg_confirm_delete_brand:"Delete this brand?",
    msg_backup_done:"âœ… Backup downloaded!",
    msg_backup_auto_on:"âœ… Automatic daily backup enabled.",
    msg_backup_auto_off:"Automatic backup disabled.",
    msg_reset_confirm:"Type 'yes' to confirm:",
    msg_reset_done:"âœ… System reset complete.",
    msg_reset_cancel:"Operation cancelled.",
    settle_prompt:"Enter amount paid:",
    settle_ok:"âœ… Payment recorded: ",
    settle_from:" from ",
    no_stock:"Stock is empty", no_families:"No families yet",
    no_brands:"No brands yet", no_customers:"No customers yet",
    msg_clear_month_confirm:"Delete all sales data for this month? This cannot be undone.",
    msg_clear_year_confirm:"Delete all sales data for this year? This cannot be undone.",
    msg_clear_done:"âœ… Data cleared successfully.",
    msg_clear_cancel:"Operation cancelled.",
  }
};

/* ================================================
   t() + applyTranslations
================================================ */
function t(key) {
  const lang = DB.settings.lang || "ar";
  return (TRANSLATIONS[lang] && TRANSLATIONS[lang][key]) ||
         (TRANSLATIONS["ar"][key]) || key;
}

function applyTranslations() {
  const lang = DB.settings.lang || "ar";
  document.documentElement.lang = lang;
  document.documentElement.dir  = lang === "ar" ? "rtl" : "ltr";
  document.querySelectorAll("[data-i18n]").forEach(el => {
    const key = el.getAttribute("data-i18n");
    el.textContent = t(key);
  });
  document.querySelectorAll("[data-i18n-placeholder]").forEach(el => {
    const key = el.getAttribute("data-i18n-placeholder");
    el.placeholder = t(key);
  });
}

function previewLangChange(lang) {
  const note = document.getElementById("langNote");
  if (note) note.textContent = TRANSLATIONS[lang]?.lang_preview || t("lang_preview");
}

/* ================================================
   DATABASE
================================================ */
let DB = JSON.parse(localStorage.getItem("POSDZ")) || {
  users:    [{ name: "Admin", pin: "1234", role: "manager", immutable: true }],
  settings: {
    name:"POS DZ", phone:"", addr:"", welcome:"",
    currency:"Ø¯Ø¬", lang:"ar",
    dateFormat:"DD-MM-YYYY", timeFormat:"24", logo:"",
    printer:"default", paperSize:"80mm", copies:1,
    printLogo:false, printShopName:true, printPhone:true,
    printWelcome:true, printBarcode:false, printCustBarcode:false,
    invoiceNum:1, autoBackup:false, lastBackup:""
  },
  families:[], brands:[], stock:[], cart:[],
  customers:[], debts:[], sales:[]
};

/* ================================================
   DOM ELEMENTS
================================================ */
const loginScreen    = document.getElementById("loginScreen");
const userSelect     = document.getElementById("userSelect");
const pinInput       = document.getElementById("pin");
const mainApp        = document.getElementById("mainApp");
const usersModal     = document.getElementById("usersModal");
const usersTableBody = document.querySelector("#usersTable tbody");
const addUserForm    = document.getElementById("addUserForm");
const newUserName    = document.getElementById("newUserName");
const newUserPin     = document.getElementById("newUserPin");
const newUserRole    = document.getElementById("newUserRole");
const alertUserName  = document.getElementById("alertUserName");
const alertUserPin   = document.getElementById("alertUserPin");
const alertUserRole  = document.getElementById("alertUserRole");
const addUserInAlerts= document.getElementById("addUserInAlerts");
const stockList      = document.getElementById("stockList");
const sideMenu       = document.getElementById("sideMenu");
const menuBtn        = document.getElementById("menuBtn");
const currentTimeEl  = document.getElementById("currentTime");
const currentDateEl  = document.getElementById("currentDate");
const salePage       = document.getElementById("sale");
const cartTableBody  = document.getElementById("cart");
const searchInput    = document.getElementById("search");
const custSelect     = document.getElementById("custSelect");
const totalEl        = document.getElementById("total");

/* ================================================
   UTILITY
================================================ */
function saveDB() { localStorage.setItem("POSDZ", JSON.stringify(DB)); }
function getCurrency() { return DB.settings.currency || "Ø¯Ø¬"; }
function formatPrice(val) { return Number(val).toFixed(2) + " " + getCurrency(); }

function formatDate(isoStr) {
  if (!isoStr) return "";
  const d = new Date(isoStr);
  const dd = String(d.getDate()).padStart(2,"0");
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const yy = d.getFullYear();
  return (DB.settings.dateFormat||"DD-MM-YYYY")
    .replace("DD",dd).replace("MM",mm).replace("YYYY",yy);
}

function uid() { return Date.now().toString(36)+Math.random().toString(36).slice(2); }
function isSameDay(d1,d2){ return d1.toDateString()===d2.toDateString(); }
function isSameWeek(d1,d2){
  const sw=d=>{ const x=new Date(d); x.setDate(x.getDate()-x.getDay()); x.setHours(0,0,0,0); return x; };
  return sw(d1).getTime()===sw(d2).getTime();
}
function isSameMonth(d1,d2){ return d1.getFullYear()===d2.getFullYear()&&d1.getMonth()===d2.getMonth(); }
function isSameYear(d1,d2){ return d1.getFullYear()===d2.getFullYear(); }

/* ================================================
   TOAST SYSTEM
================================================ */
function showToast(msg, type="success") {
  const toast = document.getElementById("globalToast");
  if (!toast) { console.log(msg); return; }
  const icons = { success:"âœ…", error:"âŒ", info:"â„¹ï¸", warning:"âš ï¸" };
  toast.textContent = (icons[type]||"") + " " + msg;
  toast.className = "global-toast show";
  clearTimeout(toast._timer);
  toast._timer = setTimeout(()=>{ toast.classList.remove("show"); }, 3200);
}

function showMsgBox(id, msg, type="success") {
  const el = document.getElementById(id);
  if (!el) { showToast(msg, type); return; }
  el.textContent = msg;
  el.className = "toast-msg show " + type;
  clearTimeout(el._timer);
  el._timer = setTimeout(()=>{
    el.classList.remove("show");
    setTimeout(()=>{ el.textContent=""; el.className="toast-msg"; }, 300);
  }, 3500);
}

window.alert = function(msg) {
  if (document.getElementById("mainApp").style.display === "none") {
    const lm = document.getElementById("loginMsg");
    if (lm) {
      const isErr = /Ø®Ø§Ø·Ø¦|Ø§Ø®ØªØ±|incorrect|Incorrect|Veuillez|sÃ©lectionnez/i.test(msg);
      lm.textContent = msg;
      lm.className = "login-msg " + (isErr ? "error" : "success");
      clearTimeout(lm._t);
      lm._t = setTimeout(()=>{ lm.className="login-msg"; lm.textContent=""; }, 4000);
      return;
    }
  }
  const type = /âœ…/.test(msg) ? "success" :
               /âŒ|Ø®Ø·Ø£|ÙŠØ¬Ø¨|Ø£Ø¯Ø®Ù„|Ø§Ù„Ø±Ø¬Ø§Ø¡|Ù„Ø§ ÙŠÙˆØ¬Ø¯|ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯|Ù†ÙØ°|Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚|insufficient|incorrect|introuvable|existe/i.test(msg) ? "error" : "info";
  showToast(msg, type);
};

window.confirm = function(msg) {
  return window._nativeConfirm ? window._nativeConfirm(msg) : window.__confirm(msg);
};
window.__confirm = window.confirm.bind(window);
const _origConfirm = Function.prototype.call.bind(window.__proto__.__proto__.constructor.prototype.confirm || window.__proto__.confirm) ;

/* ================================================
   SOUND SYSTEM â€” Ù†Ø¸Ø§Ù… Ø§Ù„Ø£ØµÙˆØ§Øª
================================================ */
function playSound(type) {
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain);
    gain.connect(ctx.destination);
    if (type === 'add') {
      osc.frequency.setValueAtTime(880, ctx.currentTime);
      osc.frequency.setValueAtTime(1100, ctx.currentTime + 0.08);
      gain.gain.setValueAtTime(0.3, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.2);
      osc.start(ctx.currentTime);
      osc.stop(ctx.currentTime + 0.2);
    } else if (type === 'pay') {
      osc.frequency.setValueAtTime(523, ctx.currentTime);
      osc.frequency.setValueAtTime(659, ctx.currentTime + 0.1);
      osc.frequency.setValueAtTime(784, ctx.currentTime + 0.2);
      gain.gain.setValueAtTime(0.35, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.4);
      osc.start(ctx.currentTime);
      osc.stop(ctx.currentTime + 0.4);
    }
  } catch(e) {}
}

function triggerSound(type) {
  const s = DB.settings;
  if (type === 'add' && s.soundAdd) playSound('add');
  if (type === 'pay' && s.soundPay) playSound('pay');
}

function testSound(type) { playSound(type); }

function saveSoundSettings() {
  DB.settings.soundAdd       = document.getElementById("sSoundAdd")?.checked || false;
  DB.settings.soundPay       = document.getElementById("sSoundPay")?.checked || false;
  DB.settings.barcodeReader  = document.getElementById("sBarcodeReader")?.checked || false;
  saveDB();
  showToast("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª", "success");
}

/* ================================================
   BARCODE READER â€” Ù‚Ø§Ø±Ø¦ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
================================================ */
let barcodeBuffer = "";
let barcodeTimer  = null;

document.addEventListener("keydown", function(e) {
  if (!DB.settings.barcodeReader) return;
  const activePage = document.querySelector(".page.active");
  if (!activePage || activePage.id !== "sale") return;
  const focused = document.activeElement;
  const isInput = focused && (focused.tagName === "INPUT" || focused.tagName === "SELECT" || focused.tagName === "TEXTAREA");
  if (isInput && focused.id !== "search") return;
  if (e.key === "Enter" && barcodeBuffer.length > 2) {
    const bc = barcodeBuffer.trim();
    barcodeBuffer = "";
    clearTimeout(barcodeTimer);
    const item = DB.stock.find(i => i.barcode === bc);
    if (item) {
      document.getElementById("search").value = bc;
      addItemByBarcode(bc);
    }
    return;
  }
  if (e.key.length === 1) {
    barcodeBuffer += e.key;
    clearTimeout(barcodeTimer);
    barcodeTimer = setTimeout(() => { barcodeBuffer = ""; }, 300);
  }
});

function addItemByBarcode(bc) {
  const item = DB.stock.find(i => i.barcode === bc);
  if (!item) { showToast(t("msg_not_found"), "error"); return; }
  if (item.qty <= 0) { showToast(t("msg_out_of_stock"), "error"); return; }
  const cartItem = DB.cart.find(c => c.barcode === item.barcode);
  if (cartItem) {
    if (cartItem.qty >= item.qty) { showToast(t("msg_not_enough"), "error"); return; }
    cartItem.qty += 1;
  } else {
    DB.cart.push({ name:`${item.type} ${item.brand}`, barcode:item.barcode, price:item.price, costPrice:item.costPrice, qty:1 });
  }
  triggerSound('add');
  document.getElementById("search").value = "";
  document.getElementById("searchSuggestions")?.classList.add("hidden");
  saveDB(); renderSaleStock();
}

/* ================================================
   PRINTER SEARCH â€” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø·Ø§Ø¨Ø¹Ø©
================================================ */
async function searchForPrinters() {
  const statusEl = document.getElementById("printerSearchStatus");
  const select = document.getElementById("sPrinter");
  if (statusEl) statusEl.textContent = "â³ Ø¬Ø§Ø±Ù Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø·Ø§Ø¨Ø¹Ø§Øª...";
  try {
    if (window.BrowserPrintService || navigator.bluetooth) {
      await new Promise(r => setTimeout(r, 1200));
    }
    const printers = [
      { value: "default", label: "Ø§Ù„Ø·Ø§Ø¨Ø¹Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©" },
      { value: "thermal",  label: "Ø·Ø§Ø¨Ø¹Ø© Ø­Ø±Ø§Ø±ÙŠØ© (Thermal)" },
      { value: "inkjet",   label: "Ø·Ø§Ø¨Ø¹Ø© Ø¹Ø§Ø¯ÙŠØ© (Inkjet/Laser)" },
    ];
    if (window.__detectedPrinters && window.__detectedPrinters.length) {
      window.__detectedPrinters.forEach(p => printers.push(p));
    }
    select.innerHTML = "";
    printers.forEach(p => {
      const o = document.createElement("option");
      o.value = p.value; o.textContent = p.label;
      select.appendChild(o);
    });
    select.value = DB.settings.printer || "default";
    if (statusEl) statusEl.textContent = "âœ… ØªÙ… Ø§Ù„ÙƒØ´Ù Ø¹Ù† Ø§Ù„Ø·Ø§Ø¨Ø¹Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©. ÙŠÙ‚Ø¨Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ø§Ø¨Ø¹Ø§Øª.";
    showToast("âœ… ØªÙ… Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø·Ø§Ø¨Ø¹Ø§Øª", "success");
  } catch(e) {
    if (statusEl) statusEl.textContent = "âš ï¸ ØªØ¹Ø°Ù‘Ø± Ø§Ù„ÙƒØ´Ù Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø·Ø§Ø¨Ø¹Ø© ÙŠØ¯ÙˆÙŠØ§Ù‹.";
  }
}

/* ================================================
function renderUserSelect() {
  userSelect.innerHTML = `<option value="">â€” ${t("login_title")} â€”</option>`;
  DB.users.forEach(u => {
    const o = document.createElement("option");
    o.value=u.name; o.textContent=u.name;
    userSelect.appendChild(o);
  });
}

function login() {
  const name = userSelect.value;
  const pin  = pinInput.value.trim();
  if (!name) { showToast(t("msg_select_user"), "error"); return; }
  const user = DB.users.find(u=>u.name===name&&u.pin===pin);
  if (!user) {
    const lm = document.getElementById("loginMsg");
    if (lm) {
      lm.textContent = t("msg_wrong_pin");
      lm.className = "login-msg error";
      clearTimeout(lm._t);
      lm._t = setTimeout(()=>{ lm.className="login-msg"; lm.textContent=""; }, 4000);
    }
    return;
  }
  localStorage.setItem("POSDZ_LOGGED", JSON.stringify(user));
  loginScreen.style.display="none";
  mainApp.style.display="block";
  applyHeader(); showSale(); startClock();
  checkAutoBackup();
}

function logout() {
  localStorage.removeItem("POSDZ_LOGGED");
  loginScreen.style.display="flex";
  mainApp.style.display="none";
  sideMenu.classList.add("hidden");
}

function applyHeader() {
  document.getElementById("shopName").textContent = DB.settings.name||"POS DZ";
  const logo=DB.settings.logo;
  const hl=document.getElementById("headerLogo");
  if (logo){ hl.src=logo; hl.style.display="block"; }
  else hl.style.display="none";
  applyRolePermissions();
}

function applyRolePermissions() {
  const logged = JSON.parse(localStorage.getItem("POSDZ_LOGGED"));
  const role = logged ? logged.role : "baker";
  const isManager = role === "manager";
  document.querySelectorAll("[data-role='manager']").forEach(el => {
    el.style.display = isManager ? "" : "none";
  });
  const debtBtn = document.getElementById("debtBtn");
  if (debtBtn && !isManager) {
    debtBtn.title = "Ø§Ù„Ø¨ÙŠØ¹ Ø¨Ø§Ù„Ø¯ÙŠÙ† Ù…Ø³Ù…ÙˆØ­ Ù„Ù„Ø²Ø¨Ø§Ø¦Ù† Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ† ÙÙ‚Ø·";
  }
}

/* ================================================
   NAVIGATION
================================================ */
function hideAllPages(){ document.querySelectorAll(".page").forEach(p=>p.classList.remove("active")); }

function showSale(){
  hideAllPages();
  salePage.classList.add("active");
  renderCustomerSelect();
  sideMenu.classList.add("hidden");
}

function show(id){
  const logged = JSON.parse(localStorage.getItem("POSDZ_LOGGED"));
  const role = logged ? logged.role : "baker";
  const restrictedPages = ["stock","alerts","reports","settings"];
  if (role !== "manager" && restrictedPages.includes(id)) {
    showToast("â›” Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„", "error");
    sideMenu.classList.add("hidden");
    return;
  }
  hideAllPages();
  const page=document.getElementById(id);
  if (page) page.classList.add("active");
  sideMenu.classList.add("hidden");
  if (id==="reports")   renderReports();
  if (id==="settings")  loadSettings();
  if (id==="alerts")    renderAlerts();
  if (id==="customers") renderCustomerList();
  if (id==="stock")     { renderFamilyList(); renderBrandList(); renderStock(); populateStockSelects(); }
}

function goBack(){ showSale(); }

/* ================================================
   MENU BUTTON
================================================ */
menuBtn.addEventListener("click", function(e){
  e.stopPropagation();
  sideMenu.classList.toggle("hidden");
});

document.addEventListener("click", function(e){
  if (!sideMenu.classList.contains("hidden") &&
      !sideMenu.contains(e.target) &&
      e.target !== menuBtn) {
    sideMenu.classList.add("hidden");
  }
});

/* ================================================
   SETTINGS
================================================ */
function loadSettings() {
  const s=DB.settings;
  document.getElementById("sDateFormat").value = s.dateFormat||"DD-MM-YYYY";
  document.getElementById("sTimeFormat").value = s.timeFormat||"24";
  const currEl = document.getElementById("sCurrency");
  if (currEl) {
    const cur = s.currency || "Ø¯Ø¬";
    let matched = false;
    for (let opt of currEl.options) {
      if (opt.value === cur) { opt.selected = true; matched = true; break; }
    }
    if (!matched) {
      const o = document.createElement("option");
      o.value = cur; o.textContent = cur; currEl.appendChild(o); currEl.value = cur;
    }
  }
  document.getElementById("sLang").value       = s.lang||"ar";
  document.getElementById("langNote").textContent = "";
  document.getElementById("sname").value    = s.name||"";
  document.getElementById("sphone").value   = s.phone||"";
  document.getElementById("saddr").value    = s.addr||"";
  document.getElementById("sWelcome").value = s.welcome||"";
  const lp=document.getElementById("logoPreview");
  if (s.logo&&lp){ lp.src=s.logo; lp.style.display="block"; }
  document.getElementById("sInvoiceNum").value      = s.invoiceNum||1;
  document.getElementById("sPrinter").value         = s.printer||"default";
  document.getElementById("sPaperSize").value       = s.paperSize||"80mm";
  document.getElementById("sCopies").value          = s.copies||1;
  document.getElementById("sPrintLogo").checked     = !!s.printLogo;
  document.getElementById("sPrintShopName").checked = s.printShopName!==false;
  document.getElementById("sPrintPhone").checked    = s.printPhone!==false;
  document.getElementById("sPrintWelcome").checked  = s.printWelcome!==false;
  document.getElementById("sPrintBarcode").checked  = !!s.printBarcode;
  document.getElementById("sPrintCustBarcode").checked=!!s.printCustBarcode;
  document.getElementById("sAutoBackup").checked    = !!s.autoBackup;
  updateBackupStatus();
  // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙˆØª ÙˆØ§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
  const sSoundAdd = document.getElementById("sSoundAdd");
  const sSoundPay = document.getElementById("sSoundPay");
  const sBarcodeReader = document.getElementById("sBarcodeReader");
  if (sSoundAdd) sSoundAdd.checked = !!s.soundAdd;
  if (sSoundPay) sSoundPay.checked = !!s.soundPay;
  if (sBarcodeReader) sBarcodeReader.checked = !!s.barcodeReader;
  const ff=document.getElementById("sFontFamily");
  if(ff&&s.fontFamily) ff.value=s.fontFamily;
  document.querySelectorAll(".fsz-btn").forEach(b=>{
    b.classList.toggle("active", parseInt(b.dataset.size)===(s.fontSize||15));
  });
  document.querySelectorAll(".theme-swatch").forEach(sw=>{
    sw.classList.toggle("active", sw.dataset.theme===(s.appTheme||"default"));
  });
  updateInvoicePreview();
  // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø®Ø·
  updateFontPreview();
}

function saveSettingsApp() {
  DB.settings.dateFormat  = document.getElementById("sDateFormat").value;
  DB.settings.timeFormat  = document.getElementById("sTimeFormat").value;
  DB.settings.currency    = document.getElementById("sCurrency").value || "Ø¯Ø¬";
  DB.settings.lang        = document.getElementById("sLang").value;
  const ff=document.getElementById("sFontFamily");
  if(ff) { DB.settings.fontFamily=ff.value; previewFont(); }
  const afsz=document.querySelector(".fsz-btn.active");
  if(afsz) DB.settings.fontSize=parseInt(afsz.dataset.size);
  const ath=document.querySelector(".theme-swatch.active");
  if(ath) DB.settings.appTheme=ath.dataset.theme;
  saveDB(); applyTranslations(); loadAppearanceSettings();
  showMsgBox("msgSettingsApp", t("msg_saved"), "success");
}

function saveSettingsStore() {
  DB.settings.name    = document.getElementById("sname").value.trim();
  DB.settings.phone   = document.getElementById("sphone").value.trim();
  DB.settings.addr    = document.getElementById("saddr").value.trim();
  DB.settings.welcome = document.getElementById("sWelcome").value.trim();
  saveDB(); applyHeader();
  updateInvoicePreview();
  showMsgBox("msgSettingsStore", t("msg_saved"), "success");
}

function saveSettingsPrint() {
  DB.settings.invoiceNum       = parseInt(document.getElementById("sInvoiceNum").value)||1;
  DB.settings.printer          = document.getElementById("sPrinter").value;
  DB.settings.paperSize        = document.getElementById("sPaperSize").value;
  DB.settings.copies           = parseInt(document.getElementById("sCopies").value)||1;
  DB.settings.printLogo        = document.getElementById("sPrintLogo").checked;
  DB.settings.printShopName    = document.getElementById("sPrintShopName").checked;
  DB.settings.printPhone       = document.getElementById("sPrintPhone").checked;
  DB.settings.printWelcome     = document.getElementById("sPrintWelcome").checked;
  DB.settings.printBarcode     = document.getElementById("sPrintBarcode").checked;
  DB.settings.printCustBarcode = document.getElementById("sPrintCustBarcode").checked;
  saveDB();
  updateInvoicePreview();
  showMsgBox("msgSettingsPrint", t("msg_saved"), "success");
}

function switchSettingsTab(panel, btn) {
  document.querySelectorAll(".settings-panel").forEach(p=>p.classList.remove("active"));
  document.querySelectorAll(".stab").forEach(b=>b.classList.remove("active"));
  const panelId = "settings" + panel.charAt(0).toUpperCase() + panel.slice(1);
  const panelEl = document.getElementById(panelId);
  if (panelEl) panelEl.classList.add("active");
  btn.classList.add("active");
  if (panel==="print") updateInvoicePreview();
}

function previewLogo(input) {
  const file=input.files[0]; if (!file) return;
  const r=new FileReader();
  r.onload=e=>{
    DB.settings.logo=e.target.result;
    const lp=document.getElementById("logoPreview");
    if(lp){ lp.src=e.target.result; lp.style.display="block"; }
    saveDB(); applyHeader(); updateInvoicePreview();
  };
  r.readAsDataURL(file);
}

function removeLogo() {
  DB.settings.logo="";
  const lp=document.getElementById("logoPreview");
  if(lp){ lp.src=""; lp.style.display="none"; }
  saveDB(); applyHeader(); updateInvoicePreview();
}

function saveSettings() { saveSettingsStore(); }

/* ================================================
   INVOICE PREVIEW
================================================ */
function updateInvoicePreview() {
  const preview = document.getElementById("invoicePreview");
  if (!preview) return;
  const s = DB.settings;
  const showLogo      = document.getElementById("sPrintLogo")?.checked;
  const showName      = document.getElementById("sPrintShopName")?.checked ?? s.printShopName;
  const showPhone     = document.getElementById("sPrintPhone")?.checked ?? s.printPhone;
  const showWelcome   = document.getElementById("sPrintWelcome")?.checked ?? s.printWelcome;
  const showBarcode   = document.getElementById("sPrintBarcode")?.checked ?? s.printBarcode;
  const showCustBC    = document.getElementById("sPrintCustBarcode")?.checked ?? s.printCustBarcode;
  const name    = document.getElementById("sname")?.value.trim() || s.name || "Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¬Ø±";
  const phone   = document.getElementById("sphone")?.value.trim() || s.phone || "0XXX XXX XXX";
  const welcome = document.getElementById("sWelcome")?.value.trim() || s.welcome || "Ø´ÙƒØ±Ø§Ù‹ Ù„Ø²ÙŠØ§Ø±ØªÙƒÙ…!";

  preview.innerHTML = `
    <div class="inv-paper">
      <div class="inv-header">
        ${showLogo && s.logo ? `<img src="${s.logo}" class="inv-logo" alt="logo">` : ""}
        ${showName ? `<div class="inv-shop-name">${name}</div>` : ""}
        ${showPhone ? `<div class="inv-phone">ğŸ“ ${phone}</div>` : ""}
      </div>
      <div class="inv-divider"></div>
      <div class="inv-section-label">ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</div>
      <div class="inv-row"><span>ØªØ§Ø±ÙŠØ®:</span><span>${formatDate(new Date().toISOString())}</span></div>
      <div class="inv-row"><span>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</span><span>#${s.invoiceNum||1}</span></div>
      <div class="inv-row"><span>Ø§Ù„Ø²Ø¨ÙˆÙ†:</span><span>â€”</span></div>
      <div class="inv-divider"></div>
      <div class="inv-items-header">
        <span>Ø§Ù„Ø³Ù„Ø¹Ø©</span><span>Ø§Ù„ÙƒÙ…ÙŠØ©</span><span>Ø§Ù„Ø³Ø¹Ø±</span>
      </div>
      <div class="inv-item"><span>Ù…Ø«Ø§Ù„ Ù…Ù†ØªØ¬ 1</span><span>2</span><span>150.00 Ø¯Ø¬</span></div>
      <div class="inv-item"><span>Ù…Ø«Ø§Ù„ Ù…Ù†ØªØ¬ 2</span><span>1</span><span>80.00 Ø¯Ø¬</span></div>
      <div class="inv-divider"></div>
      <div class="inv-total"><span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹:</span><span>380.00 Ø¯Ø¬</span></div>
      ${showBarcode ? `
      <div class="inv-divider"></div>
      <div class="inv-section-label">Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div>
      <div class="inv-barcode-row">
        <div class="inv-barcode-item"><div class="inv-barcode-lines"></div><div class="inv-bc-num">123456789</div></div>
        <div class="inv-barcode-item"><div class="inv-barcode-lines"></div><div class="inv-bc-num">987654321</div></div>
      </div>` : ""}
      ${showCustBC ? `
      <div class="inv-divider"></div>
      <div class="inv-section-label">Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</div>
      <div style="text-align:center"><div class="inv-barcode-lines wide"></div><div class="inv-bc-num">#${s.invoiceNum||1}-${Date.now().toString(36).toUpperCase()}</div></div>` : ""}
      ${showWelcome ? `
      <div class="inv-divider"></div>
      <div class="inv-welcome">${welcome}</div>` : ""}
    </div>`;
}

document.addEventListener("DOMContentLoaded", ()=>{
  ["sPrintLogo","sPrintShopName","sPrintPhone","sPrintWelcome","sPrintBarcode","sPrintCustBarcode"].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.addEventListener("change", updateInvoicePreview);
  });
  ["sname","sphone","sWelcome"].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.addEventListener("input", updateInvoicePreview);
  });
});

/* ================================================
   PIN VISIBILITY TOGGLE
================================================ */
function togglePinVisibility() {
  const pin = document.getElementById("pin");
  const icon = document.getElementById("eyeIcon");
  if (!pin) return;
  if (pin.type === "password") {
    pin.type = "text";
    icon.innerHTML = '<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line>';
  } else {
    pin.type = "password";
    icon.innerHTML = '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle>';
  }
}

/* ================================================
   APPEARANCE
================================================ */
function updateFontPreview() {
  const box = document.getElementById("fontPreviewBox");
  if (!box) return;
  const ff = document.getElementById("sFontFamily")?.value || DB.settings.fontFamily || "Cairo";
  box.style.fontFamily = `'${ff}', system-ui, sans-serif`;
}

function previewFont() {
  const f = document.getElementById("sFontFamily")?.value;
  if(f) {
    document.documentElement.style.setProperty("--font", `'${f}', system-ui, sans-serif`);
    document.body.style.fontFamily = `'${f}', system-ui, sans-serif`;
    // ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù„Ù‰ ÙƒÙ„ Ø§Ù„Ø¹Ù†Ø§ØµØ±
    document.querySelectorAll("*").forEach(el => {
      if (el.style.fontFamily && !el.classList.contains("time-badge")) return;
    });
    updateFontPreview();
  }
}

function setFontSize(size) {
  document.documentElement.style.setProperty("--font-size-base", size+"px");
  document.body.style.fontSize = size + "px";
  document.querySelectorAll(".fsz-btn").forEach(b=>b.classList.toggle("active", parseInt(b.dataset.size)===size));
  DB.settings.fontSize = size;
}

function setTheme(theme) {
  document.documentElement.setAttribute("data-theme", theme);
  document.querySelectorAll(".theme-swatch").forEach(s=>s.classList.toggle("active", s.dataset.theme===theme));
  DB.settings.appTheme = theme;
}

function loadAppearanceSettings() {
  const s = DB.settings;
  if (s.fontFamily) {
    const ff=document.getElementById("sFontFamily");
    if(ff) ff.value=s.fontFamily;
    document.documentElement.style.setProperty("--font", `'${s.fontFamily}', system-ui, sans-serif`);
    document.body.style.fontFamily=`'${s.fontFamily}', system-ui, sans-serif`;
    updateFontPreview();
  }
  if (s.fontSize) setFontSize(s.fontSize);
  if (s.appTheme) {
    document.documentElement.setAttribute("data-theme", s.appTheme);
    document.querySelectorAll(".theme-swatch").forEach(sw=>sw.classList.toggle("active", sw.dataset.theme===s.appTheme));
  }
}

/* ================================================
   SYSTEM
================================================ */
function toggleAutoBackup(enabled) {
  DB.settings.autoBackup=enabled; saveDB();
  showToast(enabled ? t("msg_backup_auto_on") : t("msg_backup_auto_off"), enabled?"success":"info");
  updateBackupStatus();
}
function updateBackupStatus() {
  const el=document.getElementById("backupStatus"); if(!el) return;
  if (DB.settings.autoBackup) {
    const last=DB.settings.lastBackup?formatDate(DB.settings.lastBackup):"â€”";
    el.textContent=`Ø¢Ø®Ø± Ù†Ø³Ø®Ø©: ${last}`;
  } else el.textContent="";
}
function manualBackup() {
  const data=JSON.stringify(DB,null,2);
  const blob=new Blob([data],{type:"application/json"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url; a.download=`POSDZ_backup_${new Date().toISOString().slice(0,10)}.json`;
  a.click(); URL.revokeObjectURL(url);
  DB.settings.lastBackup=new Date().toISOString();
  saveDB();
  showMsgBox("msgBackup", t("msg_backup_done"), "success");
  updateBackupStatus();
}
function checkAutoBackup() {
  if (!DB.settings.autoBackup) return;
  const last=DB.settings.lastBackup;
  if (!last||!isSameDay(new Date(last),new Date())) manualBackup();
}
function confirmPartialReset() {
  const ans = window.prompt("Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙˆØ§Ù„Ø¯ÙŠÙˆÙ† ÙˆØ³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ÙÙ‚Ø·ØŸ\nØ£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆØ§Ù„Ù…Ø§Ø±ÙƒØ§Øª ÙˆØ§Ù„Ø¹Ø§Ø¦Ù„Ø§Øª Ø³ØªØ¨Ù‚Ù‰.\n\nØ§ÙƒØªØ¨ 'Ù†Ø¹Ù…' Ù„Ù„ØªØ£ÙƒÙŠØ¯:");
  if (!ans || ans.trim() !== "Ù†Ø¹Ù…") { showToast(t("msg_reset_cancel"), "info"); return; }
  DB.sales = [];
  DB.debts  = [];
  DB.customers.forEach(c => { c.debts = []; });
  saveDB();
  showToast("âœ… ØªÙ… Ø§Ù„Ù…Ø³Ø­ Ø§Ù„Ø¬Ø²Ø¦ÙŠ â€” Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆØ§Ù„Ù…Ø§Ø±ÙƒØ§Øª Ù…Ø­ÙÙˆØ¸Ø©.", "success");
  renderReports();
}

function confirmReset() {
  const confirmWord=DB.settings.lang==="fr"?"oui":DB.settings.lang==="en"?"yes":"Ù†Ø¹Ù…";
  const ans=window.prompt(t("msg_reset_confirm"));
  if (!ans||ans.trim().toLowerCase()!==confirmWord) { showToast(t("msg_reset_cancel"),"info"); return; }
  const freshDB={
    users:[{name:"Admin",pin:"1234",role:"manager",immutable:true}],
    settings:{name:"POS DZ",phone:"",addr:"",welcome:"",currency:"Ø¯Ø¬",lang:DB.settings.lang||"ar",dateFormat:"DD-MM-YYYY",timeFormat:"24",logo:"",printer:"default",paperSize:"80mm",copies:1,printLogo:false,printShopName:true,printPhone:true,printWelcome:true,printBarcode:false,printCustBarcode:false,invoiceNum:1,autoBackup:false,lastBackup:""},
    families:[],brands:[],stock:[],cart:[],customers:[],debts:[],sales:[]
  };
  DB=freshDB; saveDB();
  localStorage.removeItem("POSDZ_LOGGED");
  showToast(t("msg_reset_done"),"success");
  setTimeout(()=>location.reload(),1500);
}

/* ================================================
   STOCK TAB
================================================ */
function switchStockTab(panel, btn){
  document.querySelectorAll(".stock-panel").forEach(p=>p.classList.remove("active"));
  document.querySelectorAll(".sktab").forEach(b=>b.classList.remove("active"));
  document.getElementById("stock"+panel.charAt(0).toUpperCase()+panel.slice(1)).classList.add("active");
  btn.classList.add("active");
  // ØªØ­Ø¯ÙŠØ« placeholder Ø¨Ø­Ø« Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ Ø­Ø³Ø¨ Ø§Ù„ØªØ¨ÙˆÙŠØ¨
  const dynSearch = document.getElementById("stockDynSearch");
  if (dynSearch) {
    if (panel === "families") dynSearch.placeholder = "ğŸ” Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø§Øª...";
    else if (panel === "brands") dynSearch.placeholder = "ğŸ” Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø§Ø±ÙƒØ§Øª...";
    else dynSearch.placeholder = "ğŸ” Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...";
    dynSearch.value = "";
  }
  if (panel==="all")      { populateStockSelects(); renderStock(); }
  if (panel==="brands")   { renderBrandList(); populateBrandFamilySelect(); }
  if (panel==="families") renderFamilyList();
}

/* ================================================
   STOCK DYNAMIC SEARCH
================================================ */
function stockDynFilter() {
  const q = (document.getElementById("stockDynSearch")?.value || "").toLowerCase().trim();
  // Ø£ÙŠ ØªØ¨ÙˆÙŠØ¨ Ù†Ø´Ø·ØŸ
  if (document.getElementById("stockFamilies")?.classList.contains("active")) {
    renderFamilyListFiltered(q);
  } else if (document.getElementById("stockBrands")?.classList.contains("active")) {
    renderBrandListFiltered(q);
  } else {
    // tab all â€” ØªØ­Ø¯ÙŠØ« Ø¨Ø­Ø« Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
    const stockSearchEl = document.getElementById("stockSearch");
    if (stockSearchEl) { stockSearchEl.value = q; renderStock(); }
  }
}

/* ================================================
   FAMILIES
================================================ */
function addFamily(){
  const name=document.getElementById("familyInput").value.trim();
  if (!name) return;
  if (DB.families.find(f=>f.name.toLowerCase()===name.toLowerCase())){
    showToast(t("msg_family_exists"),"error"); return;
  }
  DB.families.push({id:uid(), name});
  document.getElementById("familyInput").value="";
  saveDB(); renderFamilyList(); populateStockSelects(); populateBrandFamilySelect();
  showToast("âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©", "success");
}
function editFamily(id){
  const fam=DB.families.find(f=>f.id===id); if(!fam) return;
  const newName=window.prompt(t("edit_btn")+" â€” "+fam.name+":", fam.name);
  if (!newName||newName.trim()===fam.name) return;
  if (DB.families.find(f=>f.name.toLowerCase()===newName.trim().toLowerCase()&&f.id!==id)){
    showToast(t("msg_family_exists"),"error"); return;
  }
  fam.name=newName.trim(); saveDB();
  renderFamilyList(); populateStockSelects(); populateBrandFamilySelect();
}
function deleteFamily(id){
  if (!window.confirm(t("msg_confirm_delete_family"))) return;
  DB.families=DB.families.filter(f=>f.id!==id);
  DB.brands=DB.brands.filter(b=>b.familyId!==id);
  saveDB(); renderFamilyList(); renderBrandList(); populateStockSelects(); populateBrandFamilySelect();
}
function renderFamilyList(filter=""){
  const list=document.getElementById("familyList");
  list.innerHTML="";
  let families = DB.families;
  if (filter) families = families.filter(f=>f.name.toLowerCase().includes(filter));
  if (!families.length){
    list.innerHTML=`<li style="color:var(--text3);text-align:center;padding:20px">${filter?"Ù„Ø§ Ù†ØªØ§Ø¦Ø¬ Ù„Ù„Ø¨Ø­Ø«":t("no_families")}</li>`; return;
  }
  families.forEach(fam=>{
    const brandsCount=DB.brands.filter(b=>b.familyId===fam.id).length;
    const li=document.createElement("li");
    li.style.cssText="display:flex;justify-content:space-between;align-items:center;padding:10px 8px;border-bottom:1px solid var(--border)";
    li.innerHTML=`
      <span>ğŸ“ <strong>${fam.name}</strong> <span style="color:var(--text3);font-size:12px">(${brandsCount} ${t("tab_brands")})</span></span>
      <span>
        <button onclick="editFamily('${fam.id}')" style="padding:5px 10px;font-size:13px;background:#3b82f6;margin-left:4px">${t("edit_btn")}</button>
        <button onclick="deleteFamily('${fam.id}')" style="padding:5px 10px;font-size:13px;background:#ef4444">${t("del_btn")}</button>
      </span>`;
    list.appendChild(li);
  });
}
function renderFamilyListFiltered(q){ renderFamilyList(q); }

/* ================================================
   BRANDS
================================================ */
function populateBrandFamilySelect(){
  const sel=document.getElementById("brandFamilySelect");
  sel.innerHTML=`<option value="">â€” ${t("family_label")} â€”</option>`;
  DB.families.forEach(f=>{
    const o=document.createElement("option");
    o.value=f.id; o.textContent=f.name; sel.appendChild(o);
  });
}
function addBrand(){
  const name=document.getElementById("brandInput").value.trim();
  const familyId=document.getElementById("brandFamilySelect").value;
  if (!name) return;
  if (!familyId){ showToast(t("msg_select_family"),"error"); return; }
  if (DB.brands.find(b=>b.name.toLowerCase()===name.toLowerCase()&&b.familyId===familyId)){
    showToast(t("msg_brand_exists"),"error"); return;
  }
  DB.brands.push({id:uid(), name, familyId});
  document.getElementById("brandInput").value="";
  saveDB(); renderBrandList(); populateStockSelects();
  showToast("âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø§Ø±ÙƒØ©","success");
}
function editBrand(id){
  const brand=DB.brands.find(b=>b.id===id); if(!brand) return;
  const newName=window.prompt(t("edit_btn")+" â€” "+brand.name+":", brand.name);
  if (!newName||newName.trim()===brand.name) return;
  brand.name=newName.trim(); saveDB(); renderBrandList(); populateStockSelects();
}
function deleteBrand(id){
  if (!window.confirm(t("msg_confirm_delete_brand"))) return;
  DB.brands=DB.brands.filter(b=>b.id!==id);
  saveDB(); renderBrandList(); populateStockSelects();
}
function renderBrandList(filter=""){
  const list=document.getElementById("brandList");
  list.innerHTML="";
  let allBrands = DB.brands;
  if (filter) allBrands = allBrands.filter(b=>b.name.toLowerCase().includes(filter));
  if (!allBrands.length){
    list.innerHTML=`<li style="color:var(--text3);text-align:center;padding:20px">${filter?"Ù„Ø§ Ù†ØªØ§Ø¦Ø¬ Ù„Ù„Ø¨Ø­Ø«":t("no_brands")}</li>`; return;
  }
  DB.families.forEach(fam=>{
    const famBrands=allBrands.filter(b=>b.familyId===fam.id);
    if (!famBrands.length) return;
    const header=document.createElement("li");
    header.style.cssText="background:var(--bg2);padding:8px 10px;font-weight:700;border-radius:6px;margin:6px 0 4px;list-style:none";
    header.textContent=`ğŸ“ ${fam.name}`;
    list.appendChild(header);
    famBrands.forEach(brand=>{
      const li=document.createElement("li");
      li.style.cssText="display:flex;justify-content:space-between;align-items:center;padding:8px 8px 8px 16px;border-bottom:1px solid var(--border)";
      li.innerHTML=`
        <span>ğŸ·ï¸ <strong>${brand.name}</strong></span>
        <span>
          <button onclick="editBrand('${brand.id}')" style="padding:5px 10px;font-size:13px;background:#3b82f6;margin-left:4px">${t("edit_btn")}</button>
          <button onclick="deleteBrand('${brand.id}')" style="padding:5px 10px;font-size:13px;background:#ef4444">${t("del_btn")}</button>
        </span>`;
      list.appendChild(li);
    });
  });
  const orphans=allBrands.filter(b=>!DB.families.find(f=>f.id===b.familyId));
  if (orphans.length){
    const header=document.createElement("li");
    header.style.cssText="background:#fef3c7;padding:8px 10px;font-weight:700;border-radius:6px;margin:6px 0 4px;list-style:none";
    header.textContent="âš ï¸ Ø¨Ø¯ÙˆÙ† Ø¹Ø§Ø¦Ù„Ø©";
    list.appendChild(header);
    orphans.forEach(brand=>{
      const li=document.createElement("li");
      li.style.cssText="display:flex;justify-content:space-between;align-items:center;padding:8px 8px 8px 16px;border-bottom:1px solid var(--border)";
      li.innerHTML=`<span>ğŸ·ï¸ ${brand.name}</span><button onclick="deleteBrand('${brand.id}')" style="padding:5px 10px;font-size:13px;background:#ef4444">${t("del_btn")}</button>`;
      list.appendChild(li);
    });
  }
}
function renderBrandListFiltered(q){ renderBrandList(q); }

/* ================================================
   STOCK SELECTS
================================================ */
function populateStockSelects(){
  const typeEl=document.getElementById("type");
  if (!typeEl) return;
  const savedType=typeEl.value;
  typeEl.innerHTML=`<option value="">â€” ${t("family_label")} â€”</option>`;
  DB.families.forEach(f=>{
    const o=document.createElement("option");
    o.value=f.name; o.textContent=f.name; o.dataset.id=f.id;
    typeEl.appendChild(o);
  });
  if (savedType) typeEl.value=savedType;
  updateBrandSelectByFamily();
}

function updateBrandSelectByFamily(){
  const typeEl=document.getElementById("type");
  const brandEl=document.getElementById("brand");
  if (!typeEl||!brandEl) return;
  const selectedFamName=typeEl.value;
  const fam=DB.families.find(f=>f.name===selectedFamName);
  const savedBrand=brandEl.value;
  brandEl.innerHTML=`<option value="">â€” ${t("brand_label")} â€”</option>`;
  const brands=fam?DB.brands.filter(b=>b.familyId===fam.id):DB.brands;
  brands.forEach(b=>{
    const o=document.createElement("option");
    o.value=b.name; o.textContent=b.name; brandEl.appendChild(o);
  });
  if (savedBrand) brandEl.value=savedBrand;
}

document.addEventListener("DOMContentLoaded",()=>{
  const typeEl=document.getElementById("type");
  if (typeEl) typeEl.addEventListener("change", updateBrandSelectByFamily);
});

/* ================================================
   STOCK MANAGEMENT
================================================ */
function saveItem(){
  const typeEl      = document.getElementById("type");
  const brandEl     = document.getElementById("brand");
  const sizeEl      = document.getElementById("size");
  const barcodeEl   = document.getElementById("barcode");
  const priceEl     = document.getElementById("price");
  const costEl      = document.getElementById("costPrice");
  const qtyEl       = document.getElementById("qty");
  const expEl       = document.getElementById("exp");

  const type      = typeEl.value.trim();
  const brand     = brandEl.value.trim();
  const size      = sizeEl.value.trim();
  let   barcode   = barcodeEl.value.trim();
  const priceStr  = priceEl.value;
  const costStr   = costEl.value;
  const qtyStr    = qtyEl.value;
  const exp       = expEl.value;

  if (!type)    { showToast("Ø§Ø®ØªØ± Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹","error"); typeEl.focus(); return; }
  if (!brand)   { showToast("Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø±ÙƒØ© Ø£ÙˆÙ„Ø§Ù‹","error"); brandEl.focus(); return; }

  if (!barcode) {
    barcode = "AUTO-" + Date.now().toString(36).toUpperCase() + "-" + Math.random().toString(36).slice(2,5).toUpperCase();
    barcodeEl.value = barcode;
  }

  const price     = priceStr !== "" ? parseFloat(priceStr) : 0;
  const costPrice = costStr  !== "" ? parseFloat(costStr)  : 0;
  const qty       = qtyStr   !== "" ? parseInt(qtyStr)     : 0;

  if (isNaN(price) || price < 0)     { showToast("Ø£Ø¯Ø®Ù„ Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ ØµØ­ÙŠØ­Ø§Ù‹","error"); priceEl.focus(); return; }
  if (isNaN(costPrice) || costPrice < 0) { showToast("Ø£Ø¯Ø®Ù„ Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ ØµØ­ÙŠØ­Ø§Ù‹","error"); costEl.focus(); return; }
  if (isNaN(qty) || qty < 0)         { showToast("Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙ…ÙŠØ© ØµØ­ÙŠØ­Ø©","error"); qtyEl.focus(); return; }

  const existing = DB.stock.find(i => i.barcode === barcode);
  if (existing) {
    existing.qty += qty;
    existing.price = price;
    existing.costPrice = costPrice;
    showToast(t("msg_item_updated"), "info");
  } else {
    DB.stock.push({ type, brand, size, barcode, price, costPrice, qty, exp });
    showToast(t("msg_item_saved"), "success");
  }

  typeEl.value=""; brandEl.value=""; sizeEl.value="";
  barcodeEl.value=""; priceEl.value=""; costEl.value="";
  qtyEl.value=""; expEl.value="";
  updateBrandSelectByFamily();
  saveDB(); renderStock();
}

function editItem(index){
  const item=DB.stock[index];
  const newPrice=window.prompt(t("price_label")+":", item.price);
  const newQty=window.prompt(t("qty_label")+":", item.qty);
  if (newPrice!==null&&!isNaN(newPrice)) item.price=parseFloat(newPrice);
  if (newQty!==null&&!isNaN(newQty))     item.qty=parseInt(newQty);
  saveDB(); renderStock();
}
function deleteItem(index){
  if (!window.confirm(t("msg_confirm_delete"))) return;
  DB.stock.splice(index,1); saveDB(); renderStock();
}

function renderStock(){
  stockList.innerHTML="";
  const q=(document.getElementById("stockSearch")?.value||"").toLowerCase();
  const list=q?DB.stock.filter(i=>i.type.toLowerCase().includes(q)||i.brand.toLowerCase().includes(q)||i.barcode.includes(q)):DB.stock;
  if (!list.length){ stockList.innerHTML=`<li style="color:var(--text3);text-align:center;padding:20px">${t("no_stock")}</li>`; return; }
  const grouped={};
  list.forEach(item=>{
    const key=`${item.type}||${item.brand}`;
    if (!grouped[key]) grouped[key]={type:item.type,brand:item.brand,items:[]};
    grouped[key].items.push(item);
  });
  Object.values(grouped).forEach(group=>{
    const header=document.createElement("li");
    header.style.cssText="background:var(--bg2);padding:8px 12px;font-weight:700;border-radius:6px;margin:8px 0 4px;list-style:none";
    header.innerHTML=`ğŸ“ ${group.type} &nbsp;â€º&nbsp; ğŸ·ï¸ ${group.brand}`;
    stockList.appendChild(header);
    group.items.forEach(item=>{
      const realIndex=DB.stock.indexOf(item);
      const expired=item.exp&&new Date(item.exp)<new Date();
      const li=document.createElement("li");
      li.style.cssText="padding:8px 12px;border-bottom:1px solid var(--border)";
      li.innerHTML=`
        <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:6px">
          <div>
            ${item.size?`<span style="color:var(--text3)">${item.size}</span> | `:""}
            Ø¨Ø§Ø±ÙƒÙˆØ¯: <code style="background:var(--bg2);padding:2px 6px;border-radius:4px">${item.barcode}</code>
            | ${t("price_label")}: <strong>${formatPrice(item.price)}</strong>
            | ${t("qty_label")}: <strong style="color:${item.qty<5?"#ef4444":"#10b981"}">${item.qty}</strong>
            ${expired?`<span style="color:#ef4444;font-size:12px"> âš  Ù…Ù†ØªÙ‡ÙŠ</span>`:""}
          </div>
          <div>
            <button onclick="editItem(${realIndex})" style="padding:5px 10px;font-size:13px;background:#3b82f6;margin-left:4px">${t("edit_btn")}</button>
            <button onclick="deleteItem(${realIndex})" style="padding:5px 10px;font-size:13px;background:#ef4444">${t("del_btn")}</button>
          </div>
        </div>`;
      stockList.appendChild(li);
    });
  });
}

/* ================================================
   CUSTOMERS
================================================ */
function renderCustomerSelect(){
  custSelect.innerHTML=`<option value="">ğŸ‘¤ â€” ${t("no_customers").replace("Ø¨Ø¹Ø¯","").trim()} â€”</option>`;
  DB.customers.forEach(c=>{
    const o=document.createElement("option"); o.value=c.name; o.textContent=c.name; // Ø§Ù„Ø§Ø³Ù… ÙÙ‚Ø· ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¨ÙŠØ¹
    custSelect.appendChild(o);
  });
}
function addCustomer(){
  const name=document.getElementById("cname").value.trim();
  const phone=(document.getElementById("cphone")?.value||"").trim();
  if (!name){ showToast(t("msg_enter_customer"),"error"); return; }
  if (DB.customers.find(c=>c.name===name)){ showToast(t("msg_customer_exists"),"error"); return; }
  DB.customers.push({name,phone,debts:[]});
  document.getElementById("cname").value="";
  if(document.getElementById("cphone")) document.getElementById("cphone").value="";
  saveDB(); renderCustomerList(); renderCustomerSelect();
  showToast("âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø²Ø¨ÙˆÙ†","success");
}
function renderCustomerList(){
  const clist=document.getElementById("clist");
  clist.innerHTML="";
  const q=(document.getElementById("customerSearch")?.value||"").toLowerCase().trim();
  let customers = DB.customers;
  if (q) customers = customers.filter(c=>c.name.toLowerCase().includes(q));
  if (!customers.length){
    clist.innerHTML=`<li style="color:var(--text3);text-align:center;padding:20px">${q?"Ù„Ø§ Ù†ØªØ§Ø¦Ø¬ Ù„Ù„Ø¨Ø­Ø«":t("no_customers")}</li>`; return;
  }
  customers.forEach((c)=>{
    const index = DB.customers.indexOf(c);
    const totalDebt=(c.debts||[]).reduce((s,d)=>s+(d.remaining||0),0);
    const li=document.createElement("li");
    li.style.cssText="display:flex;justify-content:space-between;align-items:center;padding:10px 8px;border-bottom:1px solid var(--border)";
    li.innerHTML=`
      <span><strong>${c.name}</strong>${c.phone?` <span style="color:var(--text3);font-size:12px;font-family:'IBM Plex Mono',monospace">ğŸ“ ${c.phone}</span>`:""}${totalDebt>0?` <span style="color:#ef4444;font-size:13px">(${formatPrice(totalDebt)})</span>`:""}</span>
      <button onclick="deleteCustomer(${index})" style="background:#ef4444;padding:5px 10px;font-size:13px">${t("del_btn")}</button>`;
    clist.appendChild(li);
  });
}
function deleteCustomer(index){
  if (window.confirm(t("msg_confirm_delete_customer"))){ DB.customers.splice(index,1); saveDB(); renderCustomerList(); renderCustomerSelect(); }
}

/* ================================================
   USER MANAGEMENT
================================================ */
function renderUsersTable(){
  usersTableBody.innerHTML="";
  DB.users.forEach((user,index)=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${user.name}</td>
      <td>${"*".repeat(user.pin.length)}</td>
      <td>${user.role==="manager"?t("role_manager"):t("role_seller")}</td>
      <td>
        <button onclick="editUser(${index})" ${user.immutable?"disabled":""}>${t("edit_btn")}</button>
        <button onclick="deleteUser(${index})" ${user.immutable?"disabled":""} style="background:#ef4444;margin-right:4px">${t("del_btn")}</button>
      </td>`;
    usersTableBody.appendChild(tr);
  });
}
function addUser(e){
  e.preventDefault();
  const name=newUserName.value.trim(), pin=newUserPin.value.trim(), role=newUserRole.value;
  if (!name||pin.length!==4||!/^\d+$/.test(pin)){ showToast(t("msg_pin_format"),"error"); return; }
  if (DB.users.find(u=>u.name===name)){ showToast(t("msg_user_exists"),"error"); return; }
  DB.users.push({name,pin,role,immutable:false});
  saveDB(); renderUsersTable(); renderUserSelect(); renderAlerts(); addUserForm.reset();
  showToast("âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…","success");
}
function editUser(index){
  const user = DB.users[index];
  const nameIn  = window.prompt("âœï¸ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯:", user.name);
  if (nameIn === null) return;
  const pinIn   = window.prompt("ğŸ”‘ PIN Ø§Ù„Ø¬Ø¯ÙŠØ¯ (4 Ø£Ø±Ù‚Ø§Ù…):", "");
  if (pinIn === null) return;
  const newName = nameIn.trim() || user.name;
  const newPin  = pinIn.trim();
  if (newName !== user.name && DB.users.find((u,i) => u.name === newName && i !== index)) {
    showToast(t("msg_user_exists"), "error"); return;
  }
  if (newPin && (newPin.length !== 4 || !/^\d+$/.test(newPin))) {
    showToast(t("msg_pin_4"), "error"); return;
  }
  const logged = JSON.parse(localStorage.getItem("POSDZ_LOGGED"));
  let newRole = user.role;
  if (logged && logged.role === "manager" && index !== DB.users.findIndex(u=>u.name===logged.name)) {
    const roleIn = window.prompt("ğŸ‘¤ Ø§Ù„Ø¯ÙˆØ± (manager / baker):", user.role);
    if (roleIn && ["manager","baker"].includes(roleIn.trim())) newRole = roleIn.trim();
  }
  user.name = newName;
  if (newPin) user.pin = newPin;
  user.role = newRole;
  if (logged && logged.name === (nameIn.trim() ? user.name : logged.name)) {
    localStorage.setItem("POSDZ_LOGGED", JSON.stringify(user));
  }
  saveDB(); renderUsersTable(); renderUserSelect(); renderAlerts();
  showToast("âœ… ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­", "success");
}
function deleteUser(index){
  if (DB.users[index].immutable){ showToast(t("msg_cant_delete"),"error"); return; }
  if (window.confirm(t("msg_confirm_delete_user"))){ DB.users.splice(index,1); saveDB(); renderUsersTable(); renderUserSelect(); renderAlerts(); }
}
function renderAlerts(){
  const alertList=document.getElementById("alertList");
  alertList.innerHTML="";
  DB.users.forEach((user,index)=>{
    const li=document.createElement("li");
    li.style.cssText="display:flex;justify-content:space-between;align-items:center;padding:10px 8px;border-bottom:1px solid var(--border)";
    li.innerHTML=`
      <span><strong>${user.name}</strong> â€” ${user.role==="manager"?t("role_manager"):t("role_seller")}</span>
      <span>
        <button onclick="editUser(${index})" ${user.immutable?"disabled":""} style="font-size:13px;padding:5px 10px;margin-left:4px">${t("edit_btn")}</button>
        <button onclick="deleteUser(${index})" ${user.immutable?"disabled":""} style="background:#ef4444;font-size:13px;padding:5px 10px">${t("del_btn")}</button>
      </span>`;
    alertList.appendChild(li);
  });
}
function addUserInAlertsFunc(e){
  e.preventDefault();
  const name=alertUserName.value.trim(), pin=alertUserPin.value.trim(), role=alertUserRole.value;
  if (!name||pin.length!==4||!/^\d+$/.test(pin)){ showToast(t("msg_pin_format"),"error"); return; }
  if (DB.users.find(u=>u.name===name)){ showToast(t("msg_user_exists"),"error"); return; }
  DB.users.push({name,pin,role,immutable:false});
  saveDB(); renderUsersTable(); renderUserSelect(); renderAlerts(); addUserInAlerts.reset();
  showToast("âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…","success");
}
function closeUsersModal(){ usersModal.style.display="none"; }

/* ================================================
   SEARCH SUGGESTIONS
================================================ */
function searchSuggestions() {
  const val=document.getElementById("search").value.trim().toLowerCase();
  const box=document.getElementById("searchSuggestions");
  if (!val){ box.classList.add("hidden"); return; }
  const results=DB.stock.filter(i=>
    i.type.toLowerCase().includes(val)||
    i.brand.toLowerCase().includes(val)||
    (i.size&&i.size.toLowerCase().includes(val))||
    i.barcode.includes(val)
  ).slice(0,8);
  if (!results.length){ box.classList.add("hidden"); return; }
  box.innerHTML="";
  results.forEach(item=>{
    const div=document.createElement("div");
    div.className="suggestion-item";
    const name=`${item.type} ${item.brand}${item.size?" â€” "+item.size:""}`;
    const sc=item.qty<=0?"color:#ef4444":item.qty<5?"color:#f59e0b":"color:#10b981";
    div.innerHTML=`
      <div>
        <div class="sug-name">${name}</div>
        <div class="sug-meta">Ø¨Ø§Ø±ÙƒÙˆØ¯: <code>${item.barcode}</code> | <span style="${sc}">Ù…Ø®Ø²ÙˆÙ†: ${item.qty}</span></div>
      </div>
      <span class="sug-price">${formatPrice(item.price)}</span>`;
    div.addEventListener("click",()=>{
      document.getElementById("search").value=item.barcode;
      box.classList.add("hidden");
      addItem();
    });
    box.appendChild(div);
  });
  box.classList.remove("hidden");
}
document.addEventListener("click",e=>{
  const box=document.getElementById("searchSuggestions");
  const inp=document.getElementById("search");
  if(box&&inp&&!box.contains(e.target)&&e.target!==inp) box.classList.add("hidden");
});
document.addEventListener("keydown",e=>{
  if(e.key==="Enter"&&document.activeElement===document.getElementById("search")){
    document.getElementById("searchSuggestions")?.classList.add("hidden");
    addItem();
  }
});

/* ================================================
   CART
================================================ */
function renderSaleStock(){
  cartTableBody.innerHTML="";
  DB.cart.forEach((cItem,index)=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td><input class="cart-editable" value="${cItem.name.replace(/"/g,'&quot;')}" style="width:130px" onchange="updateCartName(${index},this.value)" title="Ø§Ù†Ù‚Ø± Ù„Ù„ØªØ¹Ø¯ÙŠÙ„"></td>
      <td>
        <div style="display:flex;align-items:center;justify-content:center;gap:6px">
          <button onclick="decreaseQty(${index})" style="padding:4px 10px;background:var(--bg2);color:var(--text);border-radius:6px;font-size:16px;font-weight:900;min-width:30px">âˆ’</button>
          <strong style="font-size:15px;min-width:24px;text-align:center">${cItem.qty}</strong>
          <button onclick="increaseQty(${index})" style="padding:4px 10px;background:var(--bg2);color:var(--text);border-radius:6px;font-size:16px;font-weight:900;min-width:30px">+</button>
        </div>
      </td>
      <td><input class="cart-editable" value="${cItem.price}" type="number" min="0" step="0.01" style="width:90px;color:var(--primary);font-weight:800" onchange="updateCartPrice(${index},this.value)" title="Ø§Ù†Ù‚Ø± Ù„ØªØºÙŠÙŠØ± Ø§Ù„Ø³Ø¹Ø±"></td>
      <td style="font-weight:800;color:#10b981;font-family:'IBM Plex Mono',monospace">${formatPrice(cItem.price*cItem.qty)}</td>
      <td><button onclick="removeFromCart(${index})" style="background:#fef2f2;color:#ef4444;border:1px solid #fecaca;padding:5px 10px;font-size:13px;border-radius:6px">${t("del_btn")}</button></td>`;
    cartTableBody.appendChild(tr);
  });
  updateTotal();
}
function updateCartName(index,val){ if(val.trim()) DB.cart[index].name=val.trim(); saveDB(); renderSaleStock(); }
function updateCartPrice(index,val){ const p=parseFloat(val); if(!isNaN(p)&&p>=0) DB.cart[index].price=p; saveDB(); renderSaleStock(); }
function increaseQty(index){
  const c=DB.cart[index];
  const s=DB.stock.find(s=>s.barcode===c.barcode);
  if(s&&c.qty>=s.qty){ showToast(t("msg_not_enough"),"error"); return; }
  c.qty+=1; saveDB(); renderSaleStock();
}
function decreaseQty(index){
  DB.cart[index].qty-=1;
  if(DB.cart[index].qty<=0) DB.cart.splice(index,1);
  saveDB(); renderSaleStock();
}
function addItem(){
  const val=document.getElementById("search").value.trim().toLowerCase();
  if(!val){ showToast(t("msg_enter_search"),"error"); return; }
  const item=DB.stock.find(i=>i.type.toLowerCase().includes(val)||i.brand.toLowerCase().includes(val)||i.barcode===val||i.barcode.includes(val));
  if(!item){ showToast(t("msg_not_found"),"error"); return; }
  if(item.qty<=0){ showToast(t("msg_out_of_stock"),"error"); return; }
  const cartItem=DB.cart.find(c=>c.barcode===item.barcode);
  if(cartItem){
    if(cartItem.qty>=item.qty){ showToast(t("msg_not_enough"),"error"); return; }
    cartItem.qty+=1;
  } else {
    DB.cart.push({name:`${item.type} ${item.brand}`,barcode:item.barcode,price:item.price,costPrice:item.costPrice,qty:1});
  }
  document.getElementById("search").value="";
  document.getElementById("searchSuggestions")?.classList.add("hidden");
  triggerSound('add');
  saveDB(); renderSaleStock();
}
function removeFromCart(index){ DB.cart.splice(index,1); saveDB(); renderSaleStock(); }
function updateTotal(){ totalEl.textContent=formatPrice(DB.cart.reduce((s,i)=>s+i.price*i.qty,0)); }

/* ================================================
   PAYMENT
================================================ */
function getCartTotal(){ return DB.cart.reduce((s,i)=>s+i.price*i.qty,0); }
function deductStock(){
  DB.cart.forEach(cItem=>{
    const s=DB.stock.find(s=>s.barcode===cItem.barcode);
    if(s) s.qty-=cItem.qty;
  });
}
function buildSale(type,paid){
  const invoiceNum=DB.settings.invoiceNum||1;
  DB.settings.invoiceNum=invoiceNum+1;
  // Ø­ÙØ¸ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¹ ÙƒÙ„ Ø¹Ù…Ù„ÙŠØ©
  const logged = JSON.parse(localStorage.getItem("POSDZ_LOGGED"));
  const userName = logged ? logged.name : "â€”";
  return{invoiceNum,date:new Date().toISOString(),customer:custSelect.value||"â€”",userName,type,paid:paid||0,total:getCartTotal(),items:DB.cart.map(i=>({name:i.name,barcode:i.barcode,price:i.price,cost:i.costPrice||0,qty:i.qty}))};
}
function pay(){
  if(!DB.cart.length){ showToast(t("msg_no_cart"),"error"); return; }
  const paidVal=parseFloat(document.getElementById("paid").value);
  const total=getCartTotal();
  if(!isNaN(paidVal)&&paidVal<total){ showToast(t("msg_low_balance"),"error"); return; }
  const change=!isNaN(paidVal)?paidVal-total:0;
  deductStock();
  DB.sales.push(buildSale("ÙƒØ§Ù…Ù„",paidVal||total));
  DB.cart=[]; document.getElementById("paid").value="";
  saveDB();
  triggerSound('pay');
  showToast(change>0?t("msg_change")+formatPrice(change):t("msg_sold"),"success");
  renderSaleStock(); renderReports();
}
function partial(){
  if(!DB.cart.length){ showToast(t("msg_no_cart"),"error"); return; }
  const paidVal=parseFloat(document.getElementById("paid").value);
  const total=getCartTotal();
  if(isNaN(paidVal)||paidVal<=0){ showToast(t("msg_need_amount"),"error"); return; }
  if(paidVal>=total){ showToast(t("msg_covers_all"),"error"); return; }
  const remaining=total-paidVal;
  const customerName=custSelect.value||"â€”";
  const customer=DB.customers.find(c=>c.name===customerName);
  const debtRecord={date:new Date().toISOString(),total,paid:paidVal,remaining};
  if(customer){ customer.debts=customer.debts||[]; customer.debts.push(debtRecord); }
  deductStock();
  DB.sales.push(buildSale("Ø¬Ø²Ø¦ÙŠ",paidVal));
  DB.debts=DB.debts||[];
  DB.debts.push({customer:customerName,...debtRecord});
  DB.cart=[]; document.getElementById("paid").value="";
  saveDB();
  showToast(t("msg_partial_ok")+formatPrice(paidVal)+t("msg_partial_rem")+formatPrice(remaining),"success");
  renderSaleStock(); renderReports();
}
function toDebt(){
  if(!DB.cart.length){ showToast(t("msg_no_cart"),"error"); return; }
  const customerName=custSelect.value;
  if(!customerName){ showToast(t("msg_select_customer"),"error"); return; }
  const logged = JSON.parse(localStorage.getItem("POSDZ_LOGGED"));
  const isManager = logged && logged.role === "manager";
  const registeredCustomer = DB.customers.find(c => c.name === customerName);
  if (!isManager && !registeredCustomer) {
    showToast("â›” Ø§Ù„Ø¹Ø§Ù…Ù„ ÙŠØ³ØªØ·ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ¹ Ø¨Ø§Ù„Ø¯ÙŠÙ† Ù„Ù„Ø²Ø¨Ø§Ø¦Ù† Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ† ÙÙ‚Ø·", "error"); return;
  }
  const total=getCartTotal();
  const customer=DB.customers.find(c=>c.name===customerName);
  const debtRecord={date:new Date().toISOString(),total,paid:0,remaining:total};
  if(customer){ customer.debts=customer.debts||[]; customer.debts.push(debtRecord); }
  deductStock();
  DB.sales.push(buildSale("Ø¯ÙŠÙ†",0));
  DB.debts=DB.debts||[];
  DB.debts.push({customer:customerName,...debtRecord});
  DB.cart=[]; saveDB();
  showToast(t("msg_debt_ok")+customerName+t("msg_debt_amount")+formatPrice(total),"success");
  renderSaleStock(); renderReports();
}

/* ================================================
   REPORTS â€” Ù…Ø¹ Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ + ØªØ§Ø±ÙŠØ® Ù…Ø®ØµØµ + Ù…Ø¯Ø§Ø®ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
================================================ */
let currentReportTab="daily";
let reportNumbersVisible = false;

function toggleReportNumbers() {
  reportNumbersVisible = !reportNumbersVisible;
  const wrap = document.getElementById("reportCardsWrap");
  const btn  = document.getElementById("btnToggleNumbers");
  if (reportNumbersVisible) {
    wrap.classList.remove("hidden");
    btn.textContent = "ğŸ™ˆ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…";
  } else {
    wrap.classList.add("hidden");
    btn.textContent = "ğŸ‘ï¸ Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø£Ø±Ù‚Ø§Ù…";
  }
}

function switchReportTab(tab,btn){
  currentReportTab=tab;
  document.querySelectorAll(".rtab").forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
  // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ ØµÙ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø®ØµØµ
  const customRow = document.getElementById("customDateRow");
  if (tab==="custom") {
    customRow.classList.remove("hidden");
  } else {
    customRow.classList.add("hidden");
  }
  renderReports();
}

function filterSalesByPeriod(tab){
  const now=new Date();
  if (tab==="custom") {
    const from = document.getElementById("reportDateFrom")?.value;
    const to   = document.getElementById("reportDateTo")?.value;
    return (DB.sales||[]).filter(s=>{
      const d=new Date(s.date);
      const afterFrom = from ? d >= new Date(from) : true;
      const beforeTo  = to   ? d <= new Date(to+"T23:59:59") : true;
      return afterFrom && beforeTo;
    });
  }
  return(DB.sales||[]).filter(s=>{
    const d=new Date(s.date);
    if(tab==="daily")   return isSameDay(d,now);
    if(tab==="weekly")  return isSameWeek(d,now);
    if(tab==="monthly") return isSameMonth(d,now);
    if(tab==="yearly")  return isSameYear(d,now);
    return true;
  });
}

function getReportPeriodLabel(tab) {
  const labels = { daily:"ğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙŠÙˆÙ…", weekly:"ğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹", monthly:"ğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ù‡Ø±", yearly:"ğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ù†Ø©", all:"ğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„", custom:"ğŸ“… Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«" };
  return labels[tab] || "ğŸ“Š Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª";
}

function renderReports(){
  const sales=filterSalesByPeriod(currentReportTab);
  let revenue=0,cost=0;
  sales.forEach(s=>s.items.forEach(i=>{ revenue+=i.price*i.qty; cost+=(i.cost||0)*i.qty; }));
  document.getElementById("rSales").textContent=sales.length;
  document.getElementById("rRevenue").textContent=formatPrice(revenue);
  document.getElementById("rCost").textContent=formatPrice(cost);
  document.getElementById("rProfit").textContent=formatPrice(revenue-cost);
  // ØªØ­Ø¯ÙŠØ« Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙØªØ±Ø©
  const label = document.getElementById("reportsToggleLabel");
  if (label) label.textContent = getReportPeriodLabel(currentReportTab);
  renderDebts();
  renderSalesLog(sales);
  renderUserRevenue(sales);
}

function renderUserRevenue(sales) {
  const list = document.getElementById("userRevenueList");
  if (!list) return;
  list.innerHTML="";
  // ØªØ¬Ù…ÙŠØ¹ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
  const byUser = {};
  sales.forEach(s=>{
    const u = s.userName || "â€”";
    if (!byUser[u]) byUser[u] = { revenue:0, count:0 };
    s.items.forEach(i=>{ byUser[u].revenue += i.price*i.qty; });
    byUser[u].count++;
  });
  const entries = Object.entries(byUser).sort((a,b)=>b[1].revenue-a[1].revenue);
  if (!entries.length) {
    list.innerHTML=`<li style="color:var(--text3);text-align:center;padding:12px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</li>`;
    return;
  }
  entries.forEach(([name,data])=>{
    const li = document.createElement("li");
    li.className = "user-rev-item";
    li.innerHTML=`
      <span class="user-rev-name">ğŸ‘¤ ${name}</span>
      <span>
        <span class="user-rev-count">${data.count} Ø¹Ù…Ù„ÙŠØ©</span>
        &nbsp;&nbsp;
        <span class="user-rev-amount">${formatPrice(data.revenue)}</span>
      </span>`;
    list.appendChild(li);
  });
}

function renderDebts(){
  const searchQ = (document.getElementById("debtSearch")?.value||"").toLowerCase().trim();
  const byCustomer={};
  (DB.debts||[]).forEach(d=>{
    if(!byCustomer[d.customer]) byCustomer[d.customer]=0;
    byCustomer[d.customer]+=d.remaining||0;
  });
  const totalDebt=Object.values(byCustomer).reduce((s,v)=>s+v,0);
  const debtCount=Object.keys(byCustomer).filter(k=>byCustomer[k]>0).length;
  document.getElementById("rTotalDebt").textContent=formatPrice(totalDebt);
  document.getElementById("rDebtCount").textContent=debtCount;
  const debtList=document.getElementById("debtList");
  debtList.innerHTML="";
  let entries=Object.entries(byCustomer).filter(([,v])=>v>0);
  // ÙÙ„ØªØ±Ø© Ø§Ù„Ø¨Ø­Ø«
  if (searchQ) entries = entries.filter(([name])=>name.toLowerCase().includes(searchQ));
  if(!entries.length){
    debtList.innerHTML=`<li style="color:var(--text3);text-align:center;padding:20px">${searchQ?"Ù„Ø§ Ù†ØªØ§Ø¦Ø¬":t("no_debts")}</li>`; return;
  }
  entries.forEach(([name,amount])=>{
    const li=document.createElement("li");
    li.style.cssText="display:flex;justify-content:space-between;align-items:center;padding:10px 8px;border-bottom:1px solid var(--border)";
    li.innerHTML=`
      <span>ğŸ‘¤ <strong>${name}</strong></span>
      <div style="display:flex;align-items:center;gap:8px">
        <span style="color:#ef4444;font-weight:700">${formatPrice(amount)}</span>
        <button onclick="settleDebt('${name}')" style="background:#10b981;padding:4px 10px;font-size:13px">${t("settle_btn")}</button>
      </div>`;
    debtList.appendChild(li);
  });
}
function settleDebt(customerName){
  const amount=window.prompt(t("settle_prompt"));
  if(!amount||isNaN(amount)||Number(amount)<=0) return;
  const pay=parseFloat(amount);
  let remaining=pay;
  (DB.debts||[]).forEach(d=>{
    if(d.customer===customerName&&d.remaining>0&&remaining>0){
      const deduct=Math.min(d.remaining,remaining);
      d.remaining-=deduct; d.paid+=deduct; remaining-=deduct;
    }
  });
  const customer=DB.customers.find(c=>c.name===customerName);
  if(customer){ let r2=pay; (customer.debts||[]).forEach(d=>{ if(d.remaining>0&&r2>0){const x=Math.min(d.remaining,r2);d.remaining-=x;r2-=x;} }); }
  saveDB();
  showToast(t("settle_ok")+formatPrice(pay)+t("settle_from")+customerName,"success");
  renderDebts();
}
function renderSalesLog(sales){
  const salesLog=document.getElementById("salesLog");
  salesLog.innerHTML="";
  if(!sales.length){ salesLog.innerHTML=`<li style="color:var(--text3);text-align:center;padding:20px">${t("no_sales")}</li>`; return; }
  const typeColor={"ÙƒØ§Ù…Ù„":"#10b981","Ø¬Ø²Ø¦ÙŠ":"#f59e0b","Ø¯ÙŠÙ†":"#ef4444"};
  [...sales].reverse().forEach(sale=>{
    const li=document.createElement("li");
    li.style.cssText="padding:10px 8px;border-bottom:1px solid var(--border);font-size:14px";
    li.innerHTML=`
      <div style="display:flex;justify-content:space-between;flex-wrap:wrap;gap:4px">
        <span>${sale.invoiceNum?`<strong>#${sale.invoiceNum}</strong> | `:""}<span style="color:${typeColor[sale.type]||"var(--text)"};font-weight:700">${sale.type}</span> | ğŸ‘¤ ${sale.customer}${sale.userName&&sale.userName!=="â€”"?` <span style="color:var(--text3);font-size:12px">(${sale.userName})</span>`:""}</span>
        <span style="font-weight:800">${formatPrice(sale.total)}</span>
      </div>
      <div style="color:var(--text3);font-size:12px">${formatDate(sale.date)}</div>`;
    salesLog.appendChild(li);
  });
}

/* ================================================
   Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª â€” Ø´Ù‡Ø± Ø£Ùˆ Ø³Ù†Ø©
================================================ */
function clearSalesData(period) {
  const confirmMsg = period==="month" ? t("msg_clear_month_confirm") : t("msg_clear_year_confirm");
  const ans = window.prompt(confirmMsg + "\n\nØ§ÙƒØªØ¨ 'Ù†Ø¹Ù…' Ù„Ù„ØªØ£ÙƒÙŠØ¯:");
  const confirmWord = DB.settings.lang==="fr"?"oui": DB.settings.lang==="en"?"yes":"Ù†Ø¹Ù…";
  if (!ans || ans.trim().toLowerCase() !== confirmWord) {
    showToast(t("msg_clear_cancel"), "info"); return;
  }
  const now = new Date();
  if (period === "month") {
    DB.sales = (DB.sales||[]).filter(s=>!isSameMonth(new Date(s.date),now));
    DB.debts  = (DB.debts||[]).filter(d=>!isSameMonth(new Date(d.date),now));
  } else {
    DB.sales = (DB.sales||[]).filter(s=>!isSameYear(new Date(s.date),now));
    DB.debts  = (DB.debts||[]).filter(d=>!isSameYear(new Date(d.date),now));
    // Ù…Ø³Ø­ Ø§Ù„Ø¯ÙŠÙˆÙ† Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ù…Ù† Ø§Ù„Ø²Ø¨Ø§Ø¦Ù† Ø£ÙŠØ¶Ø§Ù‹
    DB.customers.forEach(c=>{
      if (c.debts) c.debts = c.debts.filter(d=>!isSameYear(new Date(d.date),now));
    });
  }
  saveDB();
  showToast(t("msg_clear_done"), "success");
  renderReports();
}

/* ================================================
   CLOCK
================================================ */
function startClock(){
  function updateTime(){
    const now=new Date();
    const fmt=DB.settings.timeFormat||"24";
    const opts=fmt==="12"?{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:true}:{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:false};
    if(currentTimeEl) currentTimeEl.textContent=now.toLocaleTimeString(undefined,opts);
    if(currentDateEl) currentDateEl.textContent=formatDate(now.toISOString());
  }
  updateTime(); setInterval(updateTime,1000);
}

/* ================================================
   INIT
================================================ */
addUserForm.addEventListener("submit", addUser);
addUserInAlerts.addEventListener("submit", addUserInAlertsFunc);

applyTranslations();
renderUsersTable();
renderUserSelect();
renderStock();
renderSaleStock();
renderCustomerSelect();
renderCustomerList();
renderFamilyList();
renderBrandList();
loadAppearanceSettings();

const logged=JSON.parse(localStorage.getItem("POSDZ_LOGGED"));
if(logged){
  loginScreen.style.display="none";
  mainApp.style.display="block";
  applyHeader(); showSale(); startClock();
  checkAutoBackup();
} else {
  loginScreen.style.display="flex";
  mainApp.style.display="none";
}
